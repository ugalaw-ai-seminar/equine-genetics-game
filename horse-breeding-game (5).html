<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horse Color Genetics Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Source+Sans+Pro:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --cream: #F5F0E6;
            --warm-brown: #8B7355;
            --dark-brown: #4A3728;
            --chestnut: #954535;
            --bay: #7B3F00;
            --black: #1C1C1C;
            --gold: #C9A227;
            --soft-green: #7D8471;
            --parchment: #E8DFD0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Source Sans Pro', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, var(--parchment) 100%);
            min-height: 100vh;
            color: var(--dark-brown);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
            border-bottom: 2px solid var(--warm-brown);
            margin-bottom: 30px;
        }

        h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.8rem;
            color: var(--dark-brown);
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        h2 {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--warm-brown);
            margin-bottom: 15px;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--warm-brown);
            font-weight: 300;
        }

        .game-section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(74, 55, 40, 0.1);
            border: 1px solid rgba(139, 115, 85, 0.2);
        }

        .status-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .missions-container {
            background: linear-gradient(135deg, var(--gold) 0%, #D4AF37 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            flex: 2;
        }

        .missions-container h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.2rem;
            margin-bottom: 10px;
            text-align: center;
        }

        .mission-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .mission-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.15);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .mission-item.completed {
            background: rgba(0,255,0,0.2);
            text-decoration: line-through;
            opacity: 0.7;
        }

        .mission-type {
            font-weight: 600;
            min-width: 100px;
        }

        .mission-item .mission-target {
            flex: 1;
            font-weight: 500;
        }

        .mission-item .mission-reward {
            font-weight: 600;
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 10px;
        }

        .mission-box {
            background: linear-gradient(135deg, var(--gold) 0%, #D4AF37 100%);
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            flex: 2;
        }

        .money-box {
            background: linear-gradient(135deg, var(--soft-green) 0%, #6B7A5E 100%);
            color: white;
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            flex: 1;
        }

        .money-box h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .money-amount {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .mission-reward {
            font-size: 0.95rem;
            margin-top: 8px;
            opacity: 0.9;
        }

        .tier-display {
            font-size: 1rem;
            font-weight: 600;
            margin-top: 8px;
            padding: 4px 10px;
            border-radius: 12px;
            display: inline-block;
            background: rgba(255,255,255,0.2);
        }

        .tier-progress {
            font-size: 0.75rem;
            margin-top: 5px;
            opacity: 0.85;
        }

        .mission-box h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            margin-bottom: 10px;
        }

        .mission-target {
            font-size: 1.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .horse-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .horse-card {
            background: var(--parchment);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .horse-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(74, 55, 40, 0.15);
        }

        .horse-card.selected {
            border-color: var(--gold);
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF5D6 100%);
        }

        .horse-icon {
            width: 100px;
            height: 80px;
            margin: 0 auto 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--parchment);
            overflow: hidden;
        }

        .horse-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .horse-icon.clickable-preview {
            cursor: zoom-in;
            transition: transform 0.2s ease;
        }

        .horse-icon.clickable-preview:hover {
            transform: scale(1.05);
        }

        .horse-label {
            font-weight: 600;
            color: var(--dark-brown);
            margin-bottom: 5px;
        }

        .horse-color {
            font-size: 0.9rem;
            color: var(--warm-brown);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .horse-genotype {
            font-size: 0.8rem;
            color: var(--soft-green);
            font-family: monospace;
            margin-top: 5px;
        }

        .horse-gender {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
            margin-top: 5px;
            font-weight: 600;
        }

        .horse-gender.stallion {
            background: linear-gradient(135deg, #4A90D9 0%, #357ABD 100%);
            color: white;
        }

        .horse-gender.mare {
            background: linear-gradient(135deg, #D94A8A 0%, #BD357A 100%);
            color: white;
        }

        .horse-value {
            font-size: 0.8rem;
            color: var(--soft-green);
            margin-top: 3px;
            font-weight: 600;
        }

        .horse-stats {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 5px;
        }

        .stat-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 500;
        }

        .stat-badge.temp-low { background: #FFE4E1; color: #8B0000; }
        .stat-badge.temp-mid { background: #FFF8DC; color: #8B7355; }
        .stat-badge.temp-high { background: #E0FFE0; color: #228B22; }

        .stat-badge.conf-low { background: #FFE4E1; color: #8B0000; }
        .stat-badge.conf-mid { background: #FFF8DC; color: #8B7355; }
        .stat-badge.conf-high { background: #E0FFE0; color: #228B22; }

        /* Age and Health Display */
        .horse-age {
            font-size: 0.8rem;
            color: var(--warm-brown);
            margin-top: 3px;
        }
        
        .horse-age.foal { color: #9370DB; font-weight: 600; }
        .horse-age.young { color: #20B2AA; }
        .horse-age.adult { color: var(--warm-brown); }
        .horse-age.senior { color: #CD853F; }
        
        .health-bar-container {
            width: 100%;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .health-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease, background 0.3s ease;
        }
        
        .health-bar.health-excellent { background: linear-gradient(90deg, #4CAF50, #8BC34A); }
        .health-bar.health-good { background: linear-gradient(90deg, #8BC34A, #CDDC39); }
        .health-bar.health-poor { background: linear-gradient(90deg, #FF9800, #FFC107); }
        .health-bar.health-critical { background: linear-gradient(90deg, #f44336, #FF5722); }
        
        .health-label {
            font-size: 0.7rem;
            margin-top: 2px;
            text-align: center;
        }
        
        .health-label.health-excellent { color: #4CAF50; }
        .health-label.health-good { color: #689F38; }
        .health-label.health-poor { color: #FF9800; }
        .health-label.health-critical { color: #f44336; }
        
        .breeding-status {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 8px;
            margin-top: 5px;
            display: inline-block;
        }
        
        .breeding-status.can-breed {
            background: #E8F5E9;
            color: #2E7D32;
        }
        
        .breeding-status.cannot-breed {
            background: #FFEBEE;
            color: #C62828;
        }
        
        .care-buttons {
            display: flex;
            gap: 5px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .btn-care {
            padding: 4px 10px;
            font-size: 0.75rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .btn-feed {
            background: linear-gradient(135deg, #8BC34A, #689F38);
            color: white;
        }
        
        .btn-feed:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(139, 195, 74, 0.4);
        }
        
        .btn-groom {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            color: white;
        }
        
        .btn-groom:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(156, 39, 176, 0.4);
        }
        
        .btn-care:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        /* Year display and advance button */
        .year-box {
            background: linear-gradient(135deg, var(--cream) 0%, var(--parchment) 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 2px solid var(--gold);
        }
        
        .year-box h3 {
            margin: 0 0 10px 0;
            color: var(--dark-brown);
        }
        
        .year-display {
            font-size: 2rem;
            font-weight: bold;
            color: var(--warm-brown);
            margin-bottom: 10px;
        }
        
        .btn-advance-year {
            background: linear-gradient(135deg, #5C6BC0, #3F51B5);
            color: white;
            padding: 8px 16px;
            font-size: 0.85rem;
        }
        
        .btn-advance-year:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(63, 81, 181, 0.4);
        }
        
        .advance-year-warning {
            font-size: 0.75rem;
            color: #C62828;
            margin-top: 8px;
        }
        
        /* Homebred indicator */
        .homebred-badge {
            color: #FFD700;
            font-size: 0.9em;
            margin-left: 3px;
        }
        
        /* Pedigree Modal */
        .pedigree-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .pedigree-modal.active {
            display: flex;
        }
        
        .pedigree-content {
            background: var(--cream);
            border-radius: 15px;
            padding: 25px;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border: 3px solid var(--gold);
        }
        
        .pedigree-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--warm-brown);
        }
        
        .pedigree-header h2 {
            color: var(--dark-brown);
            margin: 0 0 5px 0;
        }
        
        .pedigree-header .horse-info {
            color: var(--warm-brown);
            font-size: 0.95rem;
        }
        
        /* Pedigree Tree */
        .pedigree-tree {
            display: flex;
            justify-content: center;
            padding: 20px 0;
        }
        
        .pedigree-generation {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            margin: 0 5px;
        }
        
        .pedigree-node {
            background: var(--parchment);
            border: 2px solid var(--warm-brown);
            border-radius: 8px;
            padding: 8px 12px;
            margin: 5px;
            min-width: 120px;
            text-align: center;
            position: relative;
        }
        
        .pedigree-node.sire {
            border-color: #4A90D9;
            background: linear-gradient(135deg, #E3F2FD, #BBDEFB);
        }
        
        .pedigree-node.dam {
            border-color: #D94A8C;
            background: linear-gradient(135deg, #FCE4EC, #F8BBD9);
        }
        
        .pedigree-node.subject {
            border-color: var(--gold);
            border-width: 3px;
            background: linear-gradient(135deg, #FFF8E1, #FFECB3);
        }
        
        .pedigree-node.unknown {
            background: #f5f5f5;
            border-color: #ccc;
            color: #999;
            font-style: italic;
        }
        
        .pedigree-node .node-name {
            font-weight: 600;
            color: var(--dark-brown);
            font-size: 0.85rem;
            margin-bottom: 3px;
        }
        
        .pedigree-node .node-color {
            font-size: 0.75rem;
            color: var(--warm-brown);
        }
        
        .pedigree-node .node-genotype {
            font-size: 0.65rem;
            color: #666;
            font-family: monospace;
            margin-top: 3px;
        }
        
        .pedigree-connector {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            position: relative;
        }
        
        .pedigree-connector::before {
            content: '';
            position: absolute;
            width: 20px;
            height: 2px;
            background: var(--warm-brown);
        }
        
        .generation-label {
            text-align: center;
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-pedigree {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            color: white;
            padding: 4px 8px;
            font-size: 0.7rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            margin-left: 5px;
        }
        
        .btn-pedigree:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(156, 39, 176, 0.4);
        }
        
        /* Competition Styles */
        .competition-section {
            background: linear-gradient(135deg, #E8EAF6 0%, #C5CAE9 100%);
            border: 2px solid #5C6BC0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .competition-section h2 {
            color: #3949AB;
            margin-bottom: 15px;
        }
        
        .competition-types {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .competition-type-card {
            flex: 1;
            min-width: 200px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .competition-type-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .competition-type-card.selected {
            border-color: var(--gold);
            background: #FFFDE7;
        }
        
        .competition-type-card h3 {
            margin: 0 0 10px 0;
            color: #3949AB;
        }
        
        .competition-type-card .type-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .competition-type-card .type-desc {
            font-size: 0.85rem;
            color: #666;
        }
        
        .competition-horse-select {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .competition-horse-option {
            background: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 150px;
        }
        
        .competition-horse-option:hover {
            border-color: #5C6BC0;
        }
        
        .competition-horse-option.selected {
            border-color: var(--gold);
            background: #FFFDE7;
        }
        
        .btn-enter-competition {
            background: linear-gradient(135deg, #5C6BC0, #3949AB);
            color: white;
            padding: 12px 30px;
            font-size: 1rem;
        }
        
        .btn-enter-competition:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(57, 73, 171, 0.4);
        }
        
        /* Competition Results Modal */
        .competition-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .competition-modal.active {
            display: flex;
        }
        
        .competition-results {
            background: linear-gradient(135deg, #FFFDE7 0%, #FFF8E1 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 700px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border: 3px solid var(--gold);
        }
        
        .competition-results h2 {
            text-align: center;
            color: #3949AB;
            margin-bottom: 20px;
        }
        
        .results-leaderboard {
            margin-bottom: 20px;
        }
        
        .leaderboard-entry {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 2px solid #eee;
        }
        
        .leaderboard-entry.gold {
            background: linear-gradient(135deg, #FFF9C4, #FFEE58);
            border-color: #FFD700;
        }
        
        .leaderboard-entry.silver {
            background: linear-gradient(135deg, #F5F5F5, #E0E0E0);
            border-color: #C0C0C0;
        }
        
        .leaderboard-entry.bronze {
            background: linear-gradient(135deg, #FFCCBC, #FFAB91);
            border-color: #CD7F32;
        }
        
        .leaderboard-entry.player-horse {
            box-shadow: 0 0 0 3px #5C6BC0;
        }
        
        .leaderboard-position {
            font-size: 1.5rem;
            font-weight: bold;
            min-width: 50px;
            text-align: center;
        }
        
        .leaderboard-horse-info {
            flex: 1;
        }
        
        .leaderboard-horse-name {
            font-weight: 600;
            color: var(--dark-brown);
        }
        
        .leaderboard-horse-details {
            font-size: 0.85rem;
            color: #666;
        }
        
        .leaderboard-score {
            font-weight: bold;
            color: #3949AB;
            min-width: 80px;
            text-align: right;
        }
        
        .leaderboard-buy-btn {
            padding: 5px 12px;
            font-size: 0.8rem;
            background: linear-gradient(135deg, #66BB6A, #43A047);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .leaderboard-buy-btn:hover:not(:disabled) {
            transform: translateY(-1px);
        }
        
        .leaderboard-buy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .competition-reward-summary {
            text-align: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .reward-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2E7D32;
        }
        
        /* Medal display */
        .medal-badge {
            cursor: pointer;
            margin-left: 3px;
        }
        
        .medal-count {
            font-size: 0.75rem;
            vertical-align: super;
        }
        
        /* Medal history modal */
        .medal-history-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .medal-history-modal.active {
            display: flex;
        }
        
        .medal-history-content {
            background: var(--cream);
            border-radius: 15px;
            padding: 25px;
            max-width: 500px;
            width: 95%;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid var(--gold);
        }
        
        .medal-history-entry {
            padding: 10px;
            background: var(--parchment);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        
        /* Achievements Styles */
        .achievements-section {
            background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
            border: 2px solid #FF9800;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .achievements-section h2 {
            color: #E65100;
            margin-bottom: 15px;
        }
        
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .achievement-card {
            background: white;
            border-radius: 8px;
            padding: 12px;
            border: 2px solid #ddd;
            transition: all 0.3s ease;
        }
        
        .achievement-card.locked {
            opacity: 0.6;
            filter: grayscale(50%);
        }
        
        .achievement-card.unlocked {
            border-color: #4CAF50;
            background: linear-gradient(135deg, #E8F5E9, #C8E6C9);
        }
        
        .achievement-card.new {
            animation: achievementPulse 0.5s ease-out;
            border-color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }
        
        @keyframes achievementPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .achievement-icon {
            font-size: 2rem;
            text-align: center;
            margin-bottom: 5px;
        }
        
        .achievement-name {
            font-weight: 600;
            color: var(--dark-brown);
            text-align: center;
            font-size: 0.9rem;
        }
        
        .achievement-desc {
            font-size: 0.75rem;
            color: #666;
            text-align: center;
            margin-top: 3px;
        }
        
        .achievement-reward {
            font-size: 0.7rem;
            color: #2E7D32;
            text-align: center;
            margin-top: 5px;
            font-weight: 600;
        }
        
        .achievement-progress {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9rem;
            color: #666;
        }
        
        /* Achievement notification toast */
        .achievement-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 2000;
            animation: slideIn 0.5s ease-out, fadeOut 0.5s ease-in 2.5s forwards;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .toast-icon {
            font-size: 2rem;
        }
        
        .toast-content {
            text-align: left;
        }
        
        .toast-title {
            font-weight: 600;
            font-size: 1rem;
        }
        
        .toast-reward {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        /* Hint button styles */
        .btn-hint {
            background: linear-gradient(135deg, #FF9800, #F57C00);
            color: white;
            border: none;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            margin-left: 8px;
            padding: 0;
            line-height: 22px;
            transition: all 0.2s ease;
        }
        
        .btn-hint:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(255, 152, 0, 0.4);
        }
        
        .hint-popup {
            display: none;
            position: absolute;
            background: #FFF8E1;
            border: 2px solid #FF9800;
            border-radius: 8px;
            padding: 12px 15px;
            max-width: 300px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 100;
            font-size: 0.85rem;
            color: #333;
            line-height: 1.4;
        }
        
        .hint-popup.active {
            display: block;
        }
        
        .hint-popup::before {
            content: 'üí° ';
        }
        
        .mission-item {
            position: relative;
        }
        
        /* Help button in header */
        .btn-help {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s ease;
        }
        
        .btn-help:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        
        /* Guide Modal */
        .guide-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
            padding: 20px;
        }
        
        .guide-modal.active {
            display: flex;
        }
        
        .guide-content {
            background: var(--cream);
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border: 3px solid var(--warm-brown);
        }
        
        .guide-content h2 {
            color: var(--dark-brown);
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--warm-brown);
            padding-bottom: 10px;
        }
        
        .guide-section {
            margin-bottom: 25px;
        }
        
        .guide-section h3 {
            color: var(--warm-brown);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .guide-section p {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .guide-section ul {
            margin-left: 20px;
            margin-bottom: 10px;
        }
        
        .guide-section li {
            margin-bottom: 5px;
            line-height: 1.4;
        }
        
        .genetics-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 0.9rem;
        }
        
        .genetics-table th, .genetics-table td {
            border: 1px solid var(--warm-brown);
            padding: 8px 12px;
            text-align: left;
        }
        
        .genetics-table th {
            background: var(--warm-brown);
            color: white;
        }
        
        .genetics-table tr:nth-child(even) {
            background: var(--parchment);
        }
        
        /* Intro Popup */
        .intro-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }
        
        .intro-modal.active {
            display: flex;
        }
        
        .intro-content {
            background: linear-gradient(135deg, #FFF8E1 0%, #FFECB3 100%);
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 95%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border: 3px solid var(--gold);
            text-align: center;
        }
        
        .intro-content h2 {
            color: var(--dark-brown);
            margin-bottom: 20px;
        }
        
        .intro-steps {
            text-align: left;
            margin: 20px 0;
        }
        
        .intro-step {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-bottom: 15px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid var(--gold);
        }
        
        .intro-step-number {
            background: var(--gold);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .intro-step-content {
            flex: 1;
        }
        
        .intro-step-content strong {
            color: var(--dark-brown);
        }
        
        .intro-tip {
            background: #E3F2FD;
            border: 1px solid #2196F3;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .intro-tip::before {
            content: 'üí° Tip: ';
            font-weight: bold;
        }
        
        /* AI Chat Styles */
        .ai-chat-section {
            background: linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%);
            border: 2px solid #4CAF50;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .ai-chat-section h2 {
            color: #2E7D32;
            margin-bottom: 15px;
        }
        
        .api-key-setup {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .api-key-setup label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }
        
        .api-key-input-row {
            display: flex;
            gap: 10px;
        }
        
        .api-key-input-row input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        
        .api-key-input-row input:focus {
            border-color: #4CAF50;
            outline: none;
        }
        
        .btn-save-key {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-save-key:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
        }
        
        .api-key-status {
            font-size: 0.85rem;
            margin-top: 8px;
        }
        
        .api-key-status.connected {
            color: #2E7D32;
        }
        
        .api-key-status.disconnected {
            color: #C62828;
        }
        
        .chat-container {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        
        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .chat-message {
            max-width: 85%;
            padding: 10px 15px;
            border-radius: 12px;
            line-height: 1.4;
        }
        
        .chat-message.user {
            background: #E3F2FD;
            color: #1565C0;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.assistant {
            background: #F5F5F5;
            color: #333;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
        }
        
        .chat-message.system {
            background: #FFF3E0;
            color: #E65100;
            align-self: center;
            font-size: 0.85rem;
            text-align: center;
        }
        
        .chat-message.error {
            background: #FFEBEE;
            color: #C62828;
            align-self: center;
            font-size: 0.85rem;
        }
        
        .chat-message.loading {
            background: #F5F5F5;
            color: #666;
            align-self: flex-start;
            font-style: italic;
        }
        
        .chat-input-row {
            display: flex;
            border-top: 1px solid #ddd;
        }
        
        .chat-input-row input {
            flex: 1;
            padding: 15px;
            border: none;
            font-size: 1rem;
        }
        
        .chat-input-row input:focus {
            outline: none;
        }
        
        .chat-input-row input:disabled {
            background: #f5f5f5;
        }
        
        .btn-send {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            padding: 15px 25px;
            cursor: pointer;
            font-weight: 600;
        }
        
        .btn-send:hover:not(:disabled) {
            background: linear-gradient(135deg, #66BB6A, #43A047);
        }
        
        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .chat-suggestions {
            padding: 10px 15px;
            background: #FAFAFA;
            border-top: 1px solid #eee;
        }
        
        .chat-suggestions p {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 8px;
        }
        
        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .suggestion-chip {
            background: white;
            border: 1px solid #4CAF50;
            color: #2E7D32;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .suggestion-chip:hover {
            background: #4CAF50;
            color: white;
        }

        .btn {
            font-family: 'Source Sans Pro', sans-serif;
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--warm-brown) 0%, var(--dark-brown) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 55, 40, 0.3);
        }

        .btn-secondary {
            background: var(--parchment);
            color: var(--dark-brown);
            border: 2px solid var(--warm-brown);
        }

        .btn-secondary:hover {
            background: var(--warm-brown);
            color: white;
        }

        .btn-gold {
            background: linear-gradient(135deg, var(--gold) 0%, #D4AF37 100%);
            color: white;
        }

        .btn-gold:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(201, 162, 39, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .stable-horse {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: var(--parchment);
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .stable-horse:hover {
            background: #E0D5C5;
        }

        .stable-horse.selected {
            border-color: var(--gold);
            background: linear-gradient(135deg, #FFF9E6 0%, #FFF5D6 100%);
        }

        .stable-horse .horse-icon {
            width: 70px;
            height: 55px;
            margin: 0;
        }

        .stable-horse-info {
            flex: 1;
        }

        .stable-horse-name {
            font-weight: 600;
            color: var(--dark-brown);
        }

        .stable-horse-details {
            font-size: 0.85rem;
            color: var(--warm-brown);
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            text-align: center;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .preview-modal {
            position: relative;
            max-width: 350px;
        }

        .preview-modal .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--warm-brown);
            cursor: pointer;
            line-height: 1;
        }

        .preview-modal .close-btn:hover {
            color: var(--dark-brown);
        }

        .preview-image-container {
            background: var(--parchment);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .preview-image-container img {
            width: 100%;
            max-width: 280px;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        .modal h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            color: var(--dark-brown);
            margin-bottom: 20px;
        }

        .modal input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--parchment);
            border-radius: 6px;
            font-size: 1rem;
            font-family: 'Source Sans Pro', sans-serif;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }

        .modal input:focus {
            outline: none;
            border-color: var(--gold);
        }

        .new-horse-preview {
            margin: 20px 0;
        }

        .new-horse-preview .horse-icon {
            width: 140px;
            height: 110px;
            margin: 0 auto 15px;
        }

        .breeding-area {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .breeding-slot {
            background: var(--parchment);
            border: 2px dashed var(--warm-brown);
            border-radius: 10px;
            padding: 20px;
            min-width: 150px;
            text-align: center;
        }

        .breeding-slot.filled {
            border-style: solid;
            border-color: var(--gold);
        }

        .breeding-plus {
            font-size: 2rem;
            color: var(--warm-brown);
        }

        .actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .success-message {
            background: linear-gradient(135deg, var(--soft-green) 0%, #6B7A5E 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            animation: celebrate 0.5s ease;
        }

        @keyframes celebrate {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .empty-stable {
            text-align: center;
            padding: 30px;
            color: var(--warm-brown);
            font-style: italic;
        }

        .stable-full-warning {
            background: linear-gradient(135deg, var(--chestnut) 0%, #A0522D 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        .stable-count {
            font-size: 0.9rem;
            color: var(--warm-brown);
            margin-bottom: 10px;
        }

        .btn-sell {
            background: transparent;
            color: var(--chestnut);
            border: 1px solid var(--chestnut);
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        .btn-sell:hover {
            background: var(--chestnut);
            color: white;
        }

        .btn-buy {
            background: var(--soft-green);
            color: white;
            border: none;
            padding: 8px 14px;
            font-size: 0.85rem;
            border-radius: 4px;
            margin-left: 5px;
        }

        .btn-buy:hover {
            background: #6B7A5E;
        }

        .btn-buy:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .btn-breed-partner {
            background: var(--gold);
            color: white;
            border: none;
            padding: 8px 14px;
            font-size: 0.85rem;
            border-radius: 4px;
        }

        .btn-breed-partner:hover {
            background: #B8922A;
        }

        .horse-card-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            justify-content: center;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .instructions {
            background: var(--parchment);
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid var(--gold);
        }

        .instructions p {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .instructions p:last-child {
            margin-bottom: 0;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: var(--parchment);
            border: none;
            border-radius: 6px 6px 0 0;
            cursor: pointer;
            font-family: 'Source Sans Pro', sans-serif;
            font-weight: 600;
            color: var(--warm-brown);
            transition: all 0.3s ease;
        }

        .tab-btn.active {
            background: var(--warm-brown);
            color: white;
        }

        .breeding-options {
            display: none;
        }

        .breeding-options.active {
            display: block;
        }

        footer {
            text-align: center;
            padding: 20px;
            color: var(--warm-brown);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üê¥ Equine Genetics</h1>
            <p class="subtitle">A Horse Color Breeding Game</p>
        </header>

        <!-- Start Screen -->
        <div id="startScreen" class="screen active">
            <div class="game-section">
                <h2>Choose Your First Horse</h2>
                <div class="instructions">
                    <p>Welcome to Equine Genetics! Your goal is to breed horses to achieve specific coat colors.</p>
                    <p>Select one of the five horses below to begin your stable.</p>
                </div>
                <div id="starterHorses" class="horse-grid"></div>
                <div class="actions">
                    <button id="selectStarterBtn" class="btn btn-primary" disabled>Select This Horse</button>
                </div>
            </div>
        </div>

        <!-- Main Game Screen -->
        <div id="gameScreen" class="screen">
            <!-- Mission -->
            <div class="status-bar">
                <div class="missions-container">
                    <h3>üéØ Your Missions</h3>
                    <div class="mission-list">
                        <div class="mission-item" id="colorMission">
                            <span class="mission-type">Color:</span>
                            <span class="mission-target" id="missionTarget"></span>
                            <span class="mission-reward">$<span id="missionReward">0</span></span>
                            <button class="btn-hint" id="colorHintBtn" title="Get a hint">?</button>
                            <div class="hint-popup" id="colorHintPopup"></div>
                        </div>
                        <div class="mission-item" id="confMission">
                            <span class="mission-type">Conformation:</span>
                            <span class="mission-target" id="missionConfTarget"></span>
                            <span class="mission-reward">$<span id="missionConfReward">0</span></span>
                            <button class="btn-hint" id="confHintBtn" title="Get a hint">?</button>
                            <div class="hint-popup" id="confHintPopup"></div>
                        </div>
                    </div>
                </div>
                <div class="year-box">
                    <h3>üìÖ Year</h3>
                    <div class="year-display" id="yearDisplay">1</div>
                    <button class="btn btn-advance-year" id="advanceYearBtn">Advance Year</button>
                    <div class="advance-year-warning" id="advanceYearWarning" style="display: none;"></div>
                </div>
                <div class="money-box">
                    <h3>üí∞ Piggybank</h3>
                    <p class="money-amount">$<span id="moneyDisplay">0</span></p>
                    <div id="tierDisplay" class="tier-display">üê¥ Starter</div>
                    <div id="tierProgress" class="tier-progress"></div>
                    <button class="btn-help" id="helpBtn" style="margin-top: 10px;">üìñ How to Play</button>
                </div>
            </div>

            <div id="successMessage" class="success-message" style="display: none;">
                üéâ Congratulations! You've completed your mission!
                <div class="actions" style="margin-top: 15px;">
                    <button id="newMissionBtn" class="btn btn-secondary">New Mission</button>
                </div>
            </div>

            <!-- Breeding Area -->
            <div class="game-section">
                <h2>Breeding Paddock</h2>
                <div class="breeding-area">
                    <div class="breeding-slot" id="breedingSlot1">
                        <p style="color: var(--warm-brown);">Select from Stable</p>
                    </div>
                    <span class="breeding-plus">+</span>
                    <div class="breeding-slot" id="breedingSlot2">
                        <p style="color: var(--warm-brown);">Select Partner</p>
                    </div>
                </div>
                <div class="actions">
                    <button id="breedBtn" class="btn btn-gold" disabled>Breed Horses</button>
                    <button id="clearBreedingBtn" class="btn btn-secondary">Clear Selection</button>
                </div>
            </div>

            <!-- Your Stable -->
            <div class="game-section">
                <h2>Your Stable</h2>
                <div class="instructions">
                    <p>Click a horse to select it for breeding.</p>
                </div>
                <div id="stableList"></div>
            </div>

            <!-- Available Horses -->
            <div class="game-section">
                <h2>Available Horses for Breeding</h2>
                <div class="tab-buttons">
                    <button class="tab-btn active" data-tab="outside">Outside Horses</button>
                    <button class="tab-btn" data-tab="stable">Your Stable</button>
                </div>
                <div id="outsideHorses" class="breeding-options active">
                    <div class="instructions">
                        <p>These horses are available for one-time breeding. Click to view, then select as a breeding partner.</p>
                    </div>
                    <div id="availableHorses" class="horse-grid"></div>
                    <div class="actions">
                        <button id="refreshHorsesBtn" class="btn btn-secondary">Refresh Horses (<span id="refreshCount">3</span> left)</button>
                    </div>
                </div>
                <div id="stableBreeding" class="breeding-options">
                    <div class="instructions">
                        <p>Select a second horse from your stable to breed with.</p>
                    </div>
                    <div id="stablePartnerList"></div>
                </div>
            </div>

            <!-- Competitions -->
            <div class="game-section competition-section">
                <h2>üèÜ Competitions</h2>
                <div class="instructions">
                    <p>Enter your horses in competitions to win prizes! Entry fee: $25</p>
                </div>
                
                <div class="competition-types">
                    <div class="competition-type-card" data-comp-type="halter">
                        <div class="type-icon">üéÄ</div>
                        <h3>Halter Show</h3>
                        <div class="type-desc">Judged on conformation (physical build)</div>
                    </div>
                    <div class="competition-type-card" data-comp-type="colorful">
                        <div class="type-icon">üåà</div>
                        <h3>Most Colorful</h3>
                        <div class="type-desc">Judged on coat color rarity</div>
                    </div>
                </div>
                
                <div id="competitionHorseSelect" class="competition-horse-select" style="display: none;">
                    <p style="width: 100%; margin-bottom: 10px;"><strong>Select a horse to enter:</strong></p>
                </div>
                
                <div class="actions">
                    <button id="enterCompetitionBtn" class="btn btn-enter-competition" disabled>Enter Competition ($25)</button>
                </div>
            </div>

            <!-- Achievements -->
            <div class="game-section achievements-section">
                <h2>üèÖ Achievements</h2>
                <div class="achievement-progress" id="achievementProgress">0 / 0 Unlocked</div>
                <div id="achievementsGrid" class="achievements-grid"></div>
            </div>

            <!-- AI Genetics Helper Chat -->
            <div class="game-section ai-chat-section">
                <h2>ü§ñ AI Genetics Helper</h2>
                <div class="instructions">
                    <p>Ask questions about horse genetics, breeding strategies, or get advice on completing your missions!</p>
                </div>
                
                <div class="api-key-setup">
                    <label for="apiKeyInput">Anthropic API Key:</label>
                    <div class="api-key-input-row">
                        <input type="password" id="apiKeyInput" placeholder="sk-ant-api..." />
                        <button class="btn-save-key" id="saveApiKeyBtn">Save Key</button>
                    </div>
                    <div class="api-key-status disconnected" id="apiKeyStatus">‚ö™ No API key set</div>
                </div>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="chat-message system">
                            üëã Hi! I'm your genetics advisor. Enter your Anthropic API key above to get started, then ask me anything about horse breeding!
                        </div>
                    </div>
                    <div class="chat-suggestions">
                        <p>Try asking:</p>
                        <div class="suggestion-chips">
                            <span class="suggestion-chip" data-question="How do I breed a palomino?">How to breed a palomino?</span>
                            <span class="suggestion-chip" data-question="What horses should I breed to complete my color mission?">Help with my mission</span>
                            <span class="suggestion-chip" data-question="Explain how the cream gene works">Explain cream gene</span>
                            <span class="suggestion-chip" data-question="What's the difference between roan and gray?">Roan vs Gray?</span>
                        </div>
                    </div>
                    <div class="chat-input-row">
                        <input type="text" id="chatInput" placeholder="Ask about genetics..." disabled />
                        <button class="btn-send" id="sendChatBtn" disabled>Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Competition Results Modal -->
        <div id="competitionModal" class="competition-modal">
            <div class="competition-results">
                <h2 id="competitionTitle">üèÜ Competition Results</h2>
                <div id="competitionRewardSummary" class="competition-reward-summary"></div>
                <div id="resultsLeaderboard" class="results-leaderboard"></div>
                <div class="actions" style="text-align: center;">
                    <button id="closeCompetitionBtn" class="btn btn-secondary">Close</button>
                </div>
            </div>
        </div>

        <!-- Medal History Modal -->
        <div id="medalHistoryModal" class="medal-history-modal">
            <div class="medal-history-content">
                <button id="closeMedalHistoryBtn" class="close-btn">&times;</button>
                <h3 id="medalHistoryTitle">üèÜ Competition History</h3>
                <div id="medalHistoryList"></div>
            </div>
        </div>

        <!-- Horse Preview Modal -->
        <div id="horsePreviewModal" class="modal-overlay">
            <div class="modal preview-modal">
                <button id="closePreviewBtn" class="close-btn">&times;</button>
                <div class="preview-image-container">
                    <img id="previewImage" src="" alt="Horse preview">
                </div>
                <h3 id="previewName"></h3>
                <p id="previewColor" class="horse-color"></p>
                <p id="previewGenotype" class="horse-genotype"></p>
            </div>
        </div>

        <!-- Naming Modal -->
        <div id="namingModal" class="modal-overlay">
            <div class="modal">
                <h3>Name Your New Horse</h3>
                <div class="new-horse-preview">
                    <div id="newHorseIcon" class="horse-icon"></div>
                    <p id="newHorseColor" class="horse-color"></p>
                    <p id="newHorseGenotype" class="horse-genotype"></p>
                </div>
                <input type="text" id="horseNameInput" placeholder="Enter a name..." maxlength="20">
                <div class="actions">
                    <button id="confirmNameBtn" class="btn btn-primary">Confirm</button>
                </div>
            </div>
        </div>

        <!-- Pedigree Modal -->
        <div id="pedigreeModal" class="pedigree-modal">
            <div class="pedigree-content">
                <button id="closePedigreeBtn" class="close-btn">&times;</button>
                <div class="pedigree-header">
                    <h2>üèÜ Pedigree Certificate</h2>
                    <div id="pedigreeHorseInfo" class="horse-info"></div>
                </div>
                <div id="pedigreeTree" class="pedigree-tree"></div>
                <div class="actions" style="text-align: center; margin-top: 20px;">
                    <button id="closePedigreeBtn2" class="btn btn-secondary">Close</button>
                </div>
            </div>
        </div>

        <!-- How to Play Guide Modal -->
        <div id="guideModal" class="guide-modal">
            <div class="guide-content">
                <button id="closeGuideBtn" class="close-btn">&times;</button>
                <h2>üìñ How to Play - Horse Breeder's Guide</h2>
                
                <div class="guide-section">
                    <h3>üê¥ Getting Started</h3>
                    <p>Welcome to the horse breeding game! Your goal is to breed horses with specific colors and traits to complete missions, win competitions, and build a champion stable.</p>
                </div>
                
                <div class="guide-section">
                    <h3>üíï Breeding Basics</h3>
                    <p>To breed a foal:</p>
                    <ul>
                        <li><strong>Select a horse</strong> from your stable (click on it)</li>
                        <li><strong>Choose a partner</strong> - either from "Outside Horses" (one-time breeding) or from your own stable</li>
                        <li><strong>Requirements:</strong> You need one Stallion (‚ôÇ) and one Mare (‚ôÄ), both at least 3 years old with 50%+ health</li>
                        <li><strong>Note:</strong> Mares can only breed once per year, but stallions can breed unlimited times</li>
                    </ul>
                </div>
                
                <div class="guide-section">
                    <h3>‚ù§Ô∏è Health & Care</h3>
                    <p>Keep your horses healthy to breed and advance time:</p>
                    <ul>
                        <li><strong>ü•ï Feed ($10):</strong> Restores 25% health</li>
                        <li><strong>‚ú® Groom (Free):</strong> Restores 10% health</li>
                        <li>Health decays 15% each year</li>
                        <li>Horses need 50%+ health to breed or advance the year</li>
                    </ul>
                </div>
                
                <div class="guide-section">
                    <h3>üìÖ Time & Aging</h3>
                    <ul>
                        <li>Click <strong>"Advance Year"</strong> to age all horses by one year</li>
                        <li>Foals (age 0-2) cannot breed - they need to grow up first!</li>
                        <li>Horses retire at age 25</li>
                        <li>Available horses refresh each year</li>
                    </ul>
                </div>
                
                <div class="guide-section">
                    <h3>üéØ Missions</h3>
                    <p>Complete missions to earn money:</p>
                    <ul>
                        <li><strong>Color Mission:</strong> Breed a horse with the target color</li>
                        <li><strong>Conformation Mission:</strong> Breed a horse with high enough conformation score</li>
                        <li>Click the <strong>? button</strong> next to each mission for genetics hints!</li>
                        <li>Missions auto-refresh when completed</li>
                    </ul>
                </div>
                
                <div class="guide-section">
                    <h3>üèÜ Competitions</h3>
                    <p>Enter competitions to win prizes:</p>
                    <ul>
                        <li><strong>Entry fee:</strong> $25</li>
                        <li><strong>üéÄ Halter Show:</strong> Judged on conformation score</li>
                        <li><strong>üåà Most Colorful:</strong> Judged on coat color rarity</li>
                        <li><strong>Prizes:</strong> ü•á $200, ü•à $100, ü•â $50</li>
                        <li>Gold medals increase your horse's value by $100 each!</li>
                        <li>You can buy competitor horses after the show</li>
                    </ul>
                </div>
                
                <div class="guide-section">
                    <h3>‚≠ê Pedigree & Homebreding</h3>
                    <ul>
                        <li>Horses you breed get a ‚≠ê star badge</li>
                        <li>Click <strong>"üìú Pedigree"</strong> to see their family tree</li>
                        <li>Pedigrees track up to 3 generations of ancestry</li>
                    </ul>
                </div>
                
                <div class="guide-section">
                    <h3>üß¨ Genetics Quick Reference</h3>
                    <table class="genetics-table">
                        <tr>
                            <th>Gene</th>
                            <th>What It Does</th>
                        </tr>
                        <tr>
                            <td><strong>Extension (E)</strong></td>
                            <td>E_ = black pigment possible, ee = chestnut (red only)</td>
                        </tr>
                        <tr>
                            <td><strong>Agouti (A)</strong></td>
                            <td>A_ = restricts black to points (bay), aa = black all over</td>
                        </tr>
                        <tr>
                            <td><strong>Cream (Cr)</strong></td>
                            <td>One copy = dilutes (buckskin, palomino), Two copies = double dilute (cremello, perlino)</td>
                        </tr>
                        <tr>
                            <td><strong>Gray (G)</strong></td>
                            <td>Dominant - horse will gray out over time</td>
                        </tr>
                        <tr>
                            <td><strong>Roan (Rn)</strong></td>
                            <td>White hairs mixed throughout the coat</td>
                        </tr>
                        <tr>
                            <td><strong>Tobiano (To)</strong></td>
                            <td>White patches/spots pattern</td>
                        </tr>
                    </table>
                </div>
                
                <div class="actions" style="text-align: center; margin-top: 20px;">
                    <button id="closeGuideBtn2" class="btn btn-primary">Got it!</button>
                </div>
            </div>
        </div>

        <!-- Intro Popup for New Players -->
        <div id="introModal" class="intro-modal">
            <div class="intro-content">
                <h2>üê¥ Welcome to Horse Breeder!</h2>
                <p>Let's get you started with your first foal!</p>
                
                <div class="intro-steps">
                    <div class="intro-step">
                        <div class="intro-step-number">1</div>
                        <div class="intro-step-content">
                            <strong>Check your missions</strong> at the top - breed horses with the target color and conformation to earn money!
                        </div>
                    </div>
                    <div class="intro-step">
                        <div class="intro-step-number">2</div>
                        <div class="intro-step-content">
                            <strong>Click your horse</strong> in "Your Stable" to select it for breeding
                        </div>
                    </div>
                    <div class="intro-step">
                        <div class="intro-step-number">3</div>
                        <div class="intro-step-content">
                            <strong>Pick a partner</strong> from "Available Horses" - look for the opposite gender (‚ôÇ/‚ôÄ)
                        </div>
                    </div>
                    <div class="intro-step">
                        <div class="intro-step-number">4</div>
                        <div class="intro-step-content">
                            <strong>Click "Breed!"</strong> and name your new foal!
                        </div>
                    </div>
                </div>
                
                <div class="intro-tip">
                    Foals need to grow up before they can breed. Click "Advance Year" to age your horses (make sure they're healthy first - feed them if needed!)
                </div>
                
                <div class="actions" style="margin-top: 20px;">
                    <button id="closeIntroBtn" class="btn btn-primary">Let's Go!</button>
                </div>
            </div>
        </div>

        <footer>
            <p>Based on real equine color genetics: Extension (E) and Agouti (A) genes</p>
        </footer>
    </div>

    <script>
        // ============================================
        // GENETICS DATA
        // ============================================
        const GENOTYPES = [];
        // Generate all 486 genotypes programmatically
        // Extension, Agouti, Gray, Cream are independent
        // Roan/Tobiano share a locus with 6 possible combinations: nn, Rn, RR, Tn, TT, RT
        const extOptions = ['EE', 'Ee', 'ee'];
        const agoOptions = ['AA', 'Aa', 'aa'];
        const grayOptions = ['GG', 'Gg', 'gg'];
        const creamOptions = ['CrCr', 'Crcr', 'crcr'];
        const roanTobianoOptions = ['nn', 'Rn', 'RR', 'Tn', 'TT', 'RT'];
        
        for (const ext of extOptions) {
            for (const ago of agoOptions) {
                for (const gray of grayOptions) {
                    for (const cream of creamOptions) {
                        for (const roanTobiano of roanTobianoOptions) {
                            GENOTYPES.push(`${ext}/${ago}/${gray}/${cream}/${roanTobiano}`);
                        }
                    }
                }
            }
        }

        const HORSE_IMAGES = {
            // Base colors
            'Black': 'black-horse.png',
            'Bay': 'bay-horse.png',
            'Dark Bay': 'dark-bay-horse.png',
            'Chestnut': 'chestnut-horse.png',
            // Gray
            'Gray': 'gray-horse.png',
            'Gray Alt': 'gray-horse-2.png',
            // Single cream
            'Buckskin': 'buckskin-horse.png',
            'Smoky Black': 'smoky-black-horse.png',
            'Palomino': 'palomino-horse.png',
            // Double cream
            'Perlino': 'double-dilute-horse.png',
            'Smoky Cream': 'double-dilute-horse.png',
            'Cremello': 'double-dilute-horse.png',
            // Roan
            'Bay Roan': 'bay-roan-horse.png',
            'Blue Roan': 'blue-roan-horse.png',
            'Red Roan': 'red-roan-horse.png',
            // Single cream + Roan
            'Buckskin Roan': 'buckskin-roan-horse.png',
            'Smoky Black Roan': 'blue-roan-horse.png',
            'Palomino Roan': 'palomino-roan-horse.png',
            // Double cream + Roan
            'Perlino Roan': 'double-dilute-horse.png',
            'Smoky Cream Roan': 'double-dilute-horse.png',
            'Cremello Roan': 'double-dilute-horse.png',
            // Base Tobiano
            'Black Tobiano': 'black-tobiano-horse.png',
            'Bay Tobiano': 'bay-tobiano-horse.png',
            'Chestnut Tobiano': 'chestnut-tobiano-horse.png',
            // Gray Tobiano
            'Gray Tobiano': 'gray-tobiano-horse.png',
            // Single cream Tobiano
            'Buckskin Tobiano': 'buckskin-tobiano-horse.png',
            'Smoky Black Tobiano': 'black-tobiano-horse.png',
            'Palomino Tobiano': 'palomino-tobiano-horse.png',
            // Double cream Tobiano
            'Perlino Tobiano': 'double-dilute-tobiano-horse.png',
            'Smoky Cream Tobiano': 'double-dilute-tobiano-horse.png',
            'Cremello Tobiano': 'double-dilute-tobiano-horse.png',
            // Roan Tobiano
            'Bay Roan Tobiano': 'bay-roan-tobiano-horse.png',
            'Blue Roan Tobiano': 'blue-roan-tobiano-horse.png',
            'Red Roan Tobiano': 'red-roan-tobiano-horse.png',
            // Single cream + Roan Tobiano
            'Buckskin Roan Tobiano': 'buckskin-roan-tobiano-horse.png',
            'Smoky Black Roan Tobiano': 'blue-roan-tobiano-horse.png',
            'Palomino Roan Tobiano': 'palomino-roan-tobiano-horse.png',
            // Double cream + Roan Tobiano
            'Perlino Roan Tobiano': 'double-dilute-tobiano-horse.png',
            'Smoky Cream Roan Tobiano': 'double-dilute-tobiano-horse.png',
            'Cremello Roan Tobiano': 'double-dilute-tobiano-horse.png'
        };

        function getPhenotype(genotype) {
            const parts = genotype.split('/');
            const ext = parts[0];
            const ago = parts[1];
            const gray = parts[2];
            const cream = parts[3];
            const roanTobiano = parts[4];
            
            // Determine roan and tobiano from linked locus
            // nn = neither, Rn/RR = roan, Tn/TT = tobiano, RT = both
            const hasRoan = (roanTobiano === 'Rn' || roanTobiano === 'RR' || roanTobiano === 'RT');
            const hasTobiano = (roanTobiano === 'Tn' || roanTobiano === 'TT' || roanTobiano === 'RT');
            
            // If has at least one G, horse is gray (masks base color, cream, and roan - but not tobiano)
            if (gray === 'GG' || gray === 'Gg') {
                return hasTobiano ? 'Gray Tobiano' : 'Gray';
            }
            
            // Determine base color first
            let baseColor;
            if (ext === 'ee') {
                baseColor = 'Chestnut';
            } else if (ago === 'aa') {
                baseColor = 'Black';
            } else {
                baseColor = 'Bay';
            }
            
            // Build the phenotype name
            let phenotype = '';
            
            // Apply cream dilution
            if (cream === 'CrCr') {
                // Double cream
                if (baseColor === 'Bay') phenotype = 'Perlino';
                else if (baseColor === 'Black') phenotype = 'Smoky Cream';
                else if (baseColor === 'Chestnut') phenotype = 'Cremello';
            } else if (cream === 'Crcr') {
                // Single cream
                if (baseColor === 'Bay') phenotype = 'Buckskin';
                else if (baseColor === 'Black') phenotype = 'Smoky Black';
                else if (baseColor === 'Chestnut') phenotype = 'Palomino';
            } else {
                // No cream
                phenotype = baseColor;
            }
            
            // Add roan if present
            if (hasRoan) {
                if (phenotype === 'Bay') phenotype = 'Bay Roan';
                else if (phenotype === 'Black') phenotype = 'Blue Roan';
                else if (phenotype === 'Chestnut') phenotype = 'Red Roan';
                else phenotype = phenotype + ' Roan';
            }
            
            // Add tobiano if present
            if (hasTobiano) {
                phenotype = phenotype + ' Tobiano';
            }
            
            return phenotype;
        }

        // All breeding combinations with their offspring probabilities
        // Format: { 'genotype': probability }
        function getOffspringProbabilities(geno1, geno2) {
            // Parse genotypes
            const parts1 = geno1.split('/');
            const parts2 = geno2.split('/');
            const ext1 = parts1[0];
            const ago1 = parts1[1];
            const gray1 = parts1[2];
            const cream1 = parts1[3];
            const roanTobiano1 = parts1[4];
            const ext2 = parts2[0];
            const ago2 = parts2[1];
            const gray2 = parts2[2];
            const cream2 = parts2[3];
            const roanTobiano2 = parts2[4];

            // Calculate probabilities for each gene
            const extProbs = crossAlleles(ext1, ext2);
            const agoProbs = crossAlleles(ago1, ago2);
            const grayProbs = crossAlleles(gray1, gray2);
            const creamProbs = crossAlleles(cream1, cream2);
            const roanTobianoProbs = crossRoanTobianoLocus(roanTobiano1, roanTobiano2);

            // Combine into full genotype probabilities
            const results = {};
            for (const [ext, extProb] of Object.entries(extProbs)) {
                for (const [ago, agoProb] of Object.entries(agoProbs)) {
                    for (const [gray, grayProb] of Object.entries(grayProbs)) {
                        for (const [cream, creamProb] of Object.entries(creamProbs)) {
                            for (const [roanTobiano, rtProb] of Object.entries(roanTobianoProbs)) {
                                const genotype = `${ext}/${ago}/${gray}/${cream}/${roanTobiano}`;
                                results[genotype] = (results[genotype] || 0) + (extProb * agoProb * grayProb * creamProb * rtProb);
                            }
                        }
                    }
                }
            }
            return results;
        }
        
        // Special crossing function for the linked Roan/Tobiano locus
        function crossRoanTobianoLocus(allele1, allele2) {
            // Get gametes from each parent
            const gametes1 = getRoanTobianoGametes(allele1);
            const gametes2 = getRoanTobianoGametes(allele2);
            
            const results = {};
            const totalCombinations = gametes1.length * gametes2.length;
            
            for (const g1 of gametes1) {
                for (const g2 of gametes2) {
                    // Combine gametes into offspring genotype
                    const offspring = combineRoanTobianoAlleles(g1, g2);
                    results[offspring] = (results[offspring] || 0) + (1 / totalCombinations);
                }
            }
            return results;
        }
        
        // Get possible gametes from a Roan/Tobiano genotype
        function getRoanTobianoGametes(genotype) {
            switch(genotype) {
                case 'nn': return ['n', 'n'];
                case 'Rn': return ['R', 'n'];
                case 'RR': return ['R', 'R'];
                case 'Tn': return ['T', 'n'];
                case 'TT': return ['T', 'T'];
                case 'RT': return ['R', 'T'];
                default: return ['n', 'n'];
            }
        }
        
        // Combine two gametes into offspring genotype at Roan/Tobiano locus
        function combineRoanTobianoAlleles(a1, a2) {
            // Sort to normalize (R before T before n, but RT is special)
            if (a1 === 'R' && a2 === 'T') return 'RT';
            if (a1 === 'T' && a2 === 'R') return 'RT';
            if (a1 === 'R' && a2 === 'R') return 'RR';
            if (a1 === 'T' && a2 === 'T') return 'TT';
            if (a1 === 'R' && a2 === 'n') return 'Rn';
            if (a1 === 'n' && a2 === 'R') return 'Rn';
            if (a1 === 'T' && a2 === 'n') return 'Tn';
            if (a1 === 'n' && a2 === 'T') return 'Tn';
            return 'nn';
        }

        function crossAlleles(allele1, allele2) {
            // Get possible gametes from each parent
            const gametes1 = getAlleleGametes(allele1);
            const gametes2 = getAlleleGametes(allele2);

            const results = {};
            for (const g1 of gametes1) {
                for (const g2 of gametes2) {
                    // Combine and normalize (dominant first)
                    const combined = normalizeAllele(g1, g2);
                    results[combined] = (results[combined] || 0) + 0.25;
                }
            }
            return results;
        }

        function getAlleleGametes(allele) {
            // EE -> [E, E], Ee -> [E, e], ee -> [e, e]
            // AA -> [A, A], Aa -> [A, a], aa -> [a, a]
            // GG -> [G, G], Gg -> [G, g], gg -> [g, g]
            // CrCr -> [Cr, Cr], Crcr -> [Cr, cr], crcr -> [cr, cr]
            // Note: Roan/Tobiano locus is handled separately by getRoanTobianoGametes
            
            // Handle Cream gene specially (Cr/cr notation)
            if (allele === 'CrCr') return ['C', 'C'];
            if (allele === 'Crcr') return ['C', 'c'];
            if (allele === 'crcr') return ['c', 'c'];
            
            if (allele.length === 2) {
                return [allele[0], allele[1]];
            }
            return [allele, allele];
        }

        function normalizeAllele(a1, a2) {
            // Put dominant (uppercase) first
            // Determine which gene we're dealing with
            const upper1 = a1.toUpperCase();
            const upper2 = a2.toUpperCase();
            
            // Handle Cream gene (Cr)
            if (upper1 === 'C' || upper2 === 'C') {
                const hasCr1 = a1 === 'C';
                const hasCr2 = a2 === 'C';
                if (hasCr1 && hasCr2) return 'CrCr';
                if (!hasCr1 && !hasCr2) return 'crcr';
                return 'Crcr';
            }
            
            let dom, rec;
            if (upper1 === 'E') {
                dom = 'E'; rec = 'e';
            } else if (upper1 === 'A') {
                dom = 'A'; rec = 'a';
            } else if (upper1 === 'G') {
                dom = 'G'; rec = 'g';
            }

            if (a1 === dom && a2 === dom) return dom + dom;
            if (a1 === rec && a2 === rec) return rec + rec;
            return dom + rec;
        }

        function generateOffspring(geno1, geno2) {
            const probs = getOffspringProbabilities(geno1, geno2);
            const rand = Math.random();
            let cumulative = 0;

            for (const [genotype, prob] of Object.entries(probs)) {
                cumulative += prob;
                if (rand <= cumulative) {
                    return genotype;
                }
            }
            // Fallback (shouldn't happen)
            return Object.keys(probs)[0];
        }

        // ============================================
        // GAME STATE
        // ============================================
        const MAX_STABLE_SIZE = 10;
        const MAX_REFRESHES = 3;
        const BREEDING_BONUS_THRESHOLD = 10;
        const BREEDING_BONUS_AMOUNT = 100;

        // Tier thresholds based on lifetime earnings
        const TIERS = [
            { name: 'Starter', minMoney: 0, color: '#8B7355', icon: 'üê¥' },
            { name: 'Bronze', minMoney: 500, color: '#CD7F32', icon: 'ü•â' },
            { name: 'Silver', minMoney: 2000, color: '#C0C0C0', icon: 'ü•à' },
            { name: 'Gold', minMoney: 5000, color: '#FFD700', icon: 'ü•á' },
            { name: 'Platinum', minMoney: 15000, color: '#E5E4E2', icon: 'üíé' },
            { name: 'Diamond', minMoney: 50000, color: '#B9F2FF', icon: 'üëë' }
        ];

        // Sale values by rarity tier
        const SALE_VALUES = {
            // Tier 1 - Common
            'Bay': 100, 'Chestnut': 100, 'Black': 100,
            // Tier 2 - Uncommon
            'Gray': 300, 'Buckskin': 300, 'Palomino': 300, 'Smoky Black': 300,
            'Bay Roan': 300, 'Red Roan': 300, 'Blue Roan': 300,
            'Bay Tobiano': 300, 'Chestnut Tobiano': 300, 'Black Tobiano': 300,
            // Tier 3 - Rare
            'Gray Tobiano': 750, 'Cremello': 750, 'Perlino': 750, 'Smoky Cream': 750,
            'Buckskin Tobiano': 750, 'Palomino Tobiano': 750, 'Smoky Black Tobiano': 750,
            'Buckskin Roan': 750, 'Palomino Roan': 750, 'Smoky Black Roan': 750,
            'Bay Roan Tobiano': 750, 'Red Roan Tobiano': 750, 'Blue Roan Tobiano': 750,
            // Tier 4 - Very Rare
            'Cremello Tobiano': 1500, 'Perlino Tobiano': 1500, 'Smoky Cream Tobiano': 1500,
            'Cremello Roan': 1500, 'Perlino Roan': 1500, 'Smoky Cream Roan': 1500,
            'Buckskin Roan Tobiano': 1500, 'Palomino Roan Tobiano': 1500, 'Smoky Black Roan Tobiano': 1500,
            // Tier 5 - Extremely Rare
            'Cremello Roan Tobiano': 3500, 'Perlino Roan Tobiano': 3500, 'Smoky Cream Roan Tobiano': 3500
        };

        // Mission rewards by difficulty
        const MISSION_REWARDS = {
            'Bay': 50, 'Chestnut': 50, 'Black': 75,
            'Buckskin': 150, 'Palomino': 150, 'Smoky Black': 200,
            'Bay Roan': 150, 'Blue Roan': 150, 'Red Roan': 150,
            'Double Dilute': 175,
            'Bay Tobiano': 150, 'Black Tobiano': 150, 'Chestnut Tobiano': 150,
            'Cream Roan': 400, 'Cream Tobiano': 400, 'Roan Tobiano': 500
        };

        // Temperament and Conformation helper functions
        function getTemperamentLabel(score) {
            if (score <= 2) return 'Very Spirited';
            if (score <= 3) return 'Spirited';
            if (score <= 6) return 'Balanced';
            if (score <= 8) return 'Calm';
            return 'Very Calm';
        }
        
        function getConformationLabel(score) {
            if (score <= 2) return 'Poor';
            if (score <= 3) return 'Below Average';
            if (score <= 5) return 'Average';
            if (score <= 6) return 'Above Average';
            if (score <= 7) return 'Good';
            if (score <= 9) return 'Excellent';
            return 'Superior';
        }
        
        function getStatMultiplier(score) {
            if (score <= 3) return 0.7;
            if (score <= 6) return 1.0;
            return 1.5;
        }

        // Age and Health constants
        const BREEDING_AGE = 3;           // Minimum age to breed
        const MAX_AGE = 25;               // Horses retire at this age
        const STARTING_HEALTH = 75;       // New horses start with this health
        const HEALTHY_THRESHOLD = 50;     // Must be at or above to breed/age
        const FEED_COST = 10;             // Cost to feed a horse
        const FEED_HEALTH_BOOST = 25;     // Health gained from feeding
        const GROOM_HEALTH_BOOST = 10;    // Health gained from grooming (free)
        const HEALTH_DECAY_PER_YEAR = 15; // Health lost each year
        
        // Competition constants
        const COMPETITION_ENTRY_FEE = 25;
        const COMPETITION_PRIZES = {
            1: 200,  // Gold
            2: 100,  // Silver
            3: 50    // Bronze
        };
        const GOLD_MEDAL_VALUE_BONUS = 100; // Extra value per gold medal won
        
        // Achievements system
        const ACHIEVEMENTS = [
            // Breeding milestones
            { id: 'breed_1', name: 'First Foal', desc: 'Breed your first horse', icon: 'üê£', check: (gs) => gs.totalBred >= 1, reward: 50 },
            { id: 'breed_5', name: 'Growing Family', desc: 'Breed 5 horses', icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶', check: (gs) => gs.totalBred >= 5, reward: 100 },
            { id: 'breed_10', name: 'Prolific Breeder', desc: 'Breed 10 horses', icon: 'üè†', check: (gs) => gs.totalBred >= 10, reward: 200 },
            { id: 'breed_25', name: 'Horse Ranch', desc: 'Breed 25 horses', icon: 'üåæ', check: (gs) => gs.totalBred >= 25, reward: 500 },
            
            // Pedigree achievements
            { id: 'gen_2', name: 'Second Generation', desc: 'Breed a 2nd generation horse', icon: 'üë∂', check: (gs) => gs.maxGeneration >= 2, reward: 75 },
            { id: 'gen_3', name: 'Third Generation', desc: 'Breed a 3rd generation horse', icon: 'üë¥', check: (gs) => gs.maxGeneration >= 3, reward: 150 },
            
            // Stat achievements
            { id: 'excellent_conf', name: 'Show Quality', desc: 'Breed a horse with Excellent conformation (8+)', icon: 'üéÄ', check: (gs) => gs.bestConformation >= 8, reward: 100 },
            { id: 'superior_conf', name: 'Supreme Champion', desc: 'Breed a horse with Superior conformation (10)', icon: 'üèÜ', check: (gs) => gs.bestConformation >= 10, reward: 250 },
            { id: 'very_calm', name: 'Gentle Giant', desc: 'Breed a Very Calm horse (9+)', icon: 'üòå', check: (gs) => gs.calmestHorse >= 9, reward: 100 },
            { id: 'very_spirited', name: 'Wild Spirit', desc: 'Breed a Very Spirited horse (2 or less)', icon: 'üî•', check: (gs) => gs.spiritedHorse <= 2 && gs.spiritedHorse > 0, reward: 100 },
            
            // Color achievements - Common
            { id: 'color_gray', name: 'Silver Lining', desc: 'Breed a Gray horse', icon: 'üå´Ô∏è', check: (gs) => gs.colorsBred?.includes('Gray'), reward: 50 },
            { id: 'color_buckskin', name: 'Golden Glow', desc: 'Breed a Buckskin horse', icon: '‚ú®', check: (gs) => gs.colorsBred?.includes('Buckskin'), reward: 50 },
            { id: 'color_palomino', name: 'Golden Dream', desc: 'Breed a Palomino horse', icon: 'üåü', check: (gs) => gs.colorsBred?.includes('Palomino'), reward: 50 },
            
            // Color achievements - Rare
            { id: 'color_roan', name: 'Roan Ranger', desc: 'Breed any Roan horse', icon: 'üé®', check: (gs) => gs.colorsBred?.some(c => c.includes('Roan')), reward: 75 },
            { id: 'color_tobiano', name: 'Paint by Numbers', desc: 'Breed any Tobiano horse', icon: 'üñåÔ∏è', check: (gs) => gs.colorsBred?.some(c => c.includes('Tobiano')), reward: 75 },
            { id: 'color_cremello', name: 'Cream Dream', desc: 'Breed a Cremello horse', icon: 'üç¶', check: (gs) => gs.colorsBred?.includes('Cremello'), reward: 100 },
            
            // Color achievements - Very Rare
            { id: 'color_roan_tobiano', name: 'Double Pattern', desc: 'Breed a Roan Tobiano horse', icon: 'üé≠', check: (gs) => gs.colorsBred?.some(c => c.includes('Roan') && c.includes('Tobiano')), reward: 200 },
            { id: 'color_cream_roan', name: 'Creamy Roan', desc: 'Breed a Cream Roan horse', icon: 'ü•õ', check: (gs) => gs.colorsBred?.some(c => (c.includes('Buckskin') || c.includes('Palomino') || c.includes('Cremello') || c.includes('Perlino')) && c.includes('Roan') && !c.includes('Tobiano')), reward: 250 },
            { id: 'color_cream_roan_tobiano', name: 'Triple Threat', desc: 'Breed a Cream Roan Tobiano horse', icon: 'üëë', check: (gs) => gs.colorsBred?.some(c => (c.includes('Buckskin') || c.includes('Palomino') || c.includes('Cremello') || c.includes('Perlino')) && c.includes('Roan') && c.includes('Tobiano')), reward: 500 },
            
            // Competition achievements
            { id: 'comp_enter', name: 'Competitor', desc: 'Enter your first competition', icon: 'üé™', check: (gs) => gs.competitionsEntered >= 1, reward: 25 },
            { id: 'comp_win', name: 'Winner\'s Circle', desc: 'Win a gold medal', icon: 'ü•á', check: (gs) => gs.goldMedals >= 1, reward: 100 },
            { id: 'comp_5_gold', name: 'Champion Stable', desc: 'Win 5 gold medals', icon: 'üèÖ', check: (gs) => gs.goldMedals >= 5, reward: 300 },
            
            // Money achievements
            { id: 'money_500', name: 'Comfortable', desc: 'Earn $500 total', icon: 'üíµ', check: (gs) => gs.totalEarnings >= 500, reward: 50 },
            { id: 'money_2000', name: 'Prosperous', desc: 'Earn $2,000 total', icon: 'üí∞', check: (gs) => gs.totalEarnings >= 2000, reward: 100 },
            { id: 'money_10000', name: 'Wealthy Rancher', desc: 'Earn $10,000 total', icon: 'ü§ë', check: (gs) => gs.totalEarnings >= 10000, reward: 250 },
        ];
        
        // Color rarity scores for "Most Colorful" competition
        const COLOR_RARITY_SCORES = {
            // Tier 1 - Common (1 point)
            'Bay': 1, 'Chestnut': 1, 'Black': 1,
            // Tier 2 - Uncommon (3 points)
            'Gray': 3, 'Buckskin': 3, 'Palomino': 3, 'Smoky Black': 3,
            'Bay Roan': 3, 'Red Roan': 3, 'Blue Roan': 3,
            'Bay Tobiano': 3, 'Chestnut Tobiano': 3, 'Black Tobiano': 3,
            // Tier 3 - Rare (5 points)
            'Gray Tobiano': 5, 'Cremello': 5, 'Perlino': 5, 'Smoky Cream': 5,
            'Buckskin Tobiano': 5, 'Palomino Tobiano': 5, 'Smoky Black Tobiano': 5,
            'Buckskin Roan': 5, 'Palomino Roan': 5, 'Smoky Black Roan': 5,
            'Bay Roan Tobiano': 5, 'Red Roan Tobiano': 5, 'Blue Roan Tobiano': 5,
            // Tier 4 - Very Rare (8 points)
            'Cremello Tobiano': 8, 'Perlino Tobiano': 8, 'Smoky Cream Tobiano': 8,
            'Cremello Roan': 8, 'Perlino Roan': 8, 'Smoky Cream Roan': 8,
            'Buckskin Roan Tobiano': 8, 'Palomino Roan Tobiano': 8, 'Smoky Black Roan Tobiano': 8,
            // Tier 5 - Extremely Rare (10 points)
            'Cremello Roan Tobiano': 10, 'Perlino Roan Tobiano': 10, 'Smoky Cream Roan Tobiano': 10
        };
        
        function getHealthStatus(health) {
            if (health >= 80) return { label: 'Excellent', class: 'health-excellent' };
            if (health >= 50) return { label: 'Healthy', class: 'health-good' };
            if (health >= 25) return { label: 'Poor', class: 'health-poor' };
            return { label: 'Critical', class: 'health-critical' };
        }
        
        function canBreed(horse) {
            if (horse.age < BREEDING_AGE) return false;
            if (horse.health < HEALTHY_THRESHOLD) return false;
            if (horse.gender === 'Mare' && horse.bredThisYear) return false;
            return true;
        }
        
        function getBreedingStatus(horse) {
            if (horse.age < BREEDING_AGE) return { canBreed: false, reason: `Too young (age ${horse.age}/${BREEDING_AGE})` };
            if (horse.health < HEALTHY_THRESHOLD) return { canBreed: false, reason: `Unhealthy (${horse.health}%/${HEALTHY_THRESHOLD}%)` };
            if (horse.gender === 'Mare' && horse.bredThisYear) return { canBreed: false, reason: 'Already bred this year' };
            return { canBreed: true, reason: 'Ready to breed' };
        }
        
        function generateRandomStat() {
            // Generate a stat from 1-10 with a slight bell curve toward middle
            const roll1 = Math.ceil(Math.random() * 10);
            const roll2 = Math.ceil(Math.random() * 10);
            return Math.round((roll1 + roll2) / 2);
        }
        
        function inheritStat(parent1Stat, parent2Stat) {
            // Average of parents plus random variance
            const average = (parent1Stat + parent2Stat) / 2;
            const variance = (Math.random() * 4) - 2; // -2 to +2
            let result = Math.round(average + variance);
            // Clamp to 1-10
            return Math.max(1, Math.min(10, result));
        }

        let gameState = {
            stable: [],
            availableHorses: [],
            starterHorses: [],
            selectedStarter: null,
            selectedStableHorse: null,
            selectedPartner: null,
            partnerSource: null, // 'outside' or 'stable'
            mission: null,
            missionTemperament: null,
            missionConformation: null,
            horseIdCounter: 1,
            refreshesRemaining: MAX_REFRESHES,
            money: 100,
            breedingsSinceMission: 0,
            totalEarnings: 0,
            currentYear: 1,
            selectedCompetitionType: null,
            selectedCompetitionHorse: null,
            lastCompetitionResults: null,
            // Achievement tracking
            unlockedAchievements: [],
            totalBred: 0,
            maxGeneration: 0,
            bestConformation: 0,
            calmestHorse: 0,
            spiritedHorse: 11, // Start high so we can track lowest
            colorsBred: [],
            competitionsEntered: 0,
            goldMedals: 0
        };
        
        function getCurrentTier() {
            for (let i = TIERS.length - 1; i >= 0; i--) {
                if (gameState.totalEarnings >= TIERS[i].minMoney) {
                    return TIERS[i];
                }
            }
            return TIERS[0];
        }
        
        function getNextTier() {
            const currentTier = getCurrentTier();
            const currentIndex = TIERS.findIndex(t => t.name === currentTier.name);
            if (currentIndex < TIERS.length - 1) {
                return TIERS[currentIndex + 1];
            }
            return null;
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        // For starter horses - no roan, cream, or tobiano allowed
        function randomStarterGenotype() {
            // Only base colors: Bay, Chestnut, Black, Gray
            const rand = Math.random();
            let targetPhenotype;
            
            if (rand < 0.35) {
                targetPhenotype = 'Bay';
            } else if (rand < 0.70) {
                targetPhenotype = 'Chestnut';
            } else if (rand < 0.85) {
                targetPhenotype = 'Gray';
            } else {
                targetPhenotype = 'Black';
            }
            
            // Filter genotypes: must match phenotype AND have no cream (crcr) AND no roan/tobiano (nn)
            const matchingGenotypes = GENOTYPES.filter(g => {
                const parts = g.split('/');
                const cream = parts[3];
                const roanTobiano = parts[4];
                return getPhenotype(g) === targetPhenotype && cream === 'crcr' && roanTobiano === 'nn';
            });
            
            return matchingGenotypes[Math.floor(Math.random() * matchingGenotypes.length)];
        }

        // For breeding options - weighted probabilities for all colors
        function randomGenotype() {
            // Weighted probability for phenotypes
            const rand = Math.random();
            let targetPhenotype;
            
            if (rand < 0.18) {
                targetPhenotype = 'Bay';
            } else if (rand < 0.36) {
                targetPhenotype = 'Chestnut';
            } else if (rand < 0.46) {
                targetPhenotype = 'Gray';
            } else if (rand < 0.54) {
                targetPhenotype = 'Black';
            } else if (rand < 0.60) {
                targetPhenotype = 'Buckskin';
            } else if (rand < 0.66) {
                targetPhenotype = 'Palomino';
            } else if (rand < 0.70) {
                targetPhenotype = 'Bay Roan';
            } else if (rand < 0.74) {
                targetPhenotype = 'Blue Roan';
            } else if (rand < 0.78) {
                targetPhenotype = 'Red Roan';
            } else if (rand < 0.80) {
                targetPhenotype = 'Cremello';
            } else if (rand < 0.82) {
                targetPhenotype = 'Perlino';
            } else if (rand < 0.84) {
                targetPhenotype = 'Smoky Black';
            } else if (rand < 0.85) {
                targetPhenotype = 'Buckskin Roan';
            } else if (rand < 0.86) {
                targetPhenotype = 'Palomino Roan';
            } else if (rand < 0.87) {
                targetPhenotype = 'Smoky Black Roan';
            } else if (rand < 0.875) {
                targetPhenotype = 'Cremello Roan';
            } else if (rand < 0.88) {
                targetPhenotype = 'Perlino Roan';
            } else if (rand < 0.885) {
                targetPhenotype = 'Smoky Cream Roan';
            } else if (rand < 0.90) {
                targetPhenotype = 'Bay Tobiano';
            } else if (rand < 0.915) {
                targetPhenotype = 'Chestnut Tobiano';
            } else if (rand < 0.93) {
                targetPhenotype = 'Black Tobiano';
            } else if (rand < 0.94) {
                targetPhenotype = 'Gray Tobiano';
            } else if (rand < 0.95) {
                targetPhenotype = 'Buckskin Tobiano';
            } else if (rand < 0.96) {
                targetPhenotype = 'Palomino Tobiano';
            } else if (rand < 0.965) {
                targetPhenotype = 'Smoky Black Tobiano';
            } else if (rand < 0.97) {
                targetPhenotype = 'Cremello Tobiano';
            } else if (rand < 0.975) {
                targetPhenotype = 'Perlino Tobiano';
            } else if (rand < 0.98) {
                targetPhenotype = 'Bay Roan Tobiano';
            } else if (rand < 0.985) {
                targetPhenotype = 'Blue Roan Tobiano';
            } else if (rand < 0.99) {
                targetPhenotype = 'Red Roan Tobiano';
            } else if (rand < 0.993) {
                targetPhenotype = 'Buckskin Roan Tobiano';
            } else if (rand < 0.996) {
                targetPhenotype = 'Palomino Roan Tobiano';
            } else {
                // Remaining rare combinations
                const rareOptions = ['Smoky Black Roan Tobiano', 'Cremello Roan Tobiano', 'Perlino Roan Tobiano', 'Smoky Cream Tobiano', 'Smoky Cream Roan Tobiano'];
                targetPhenotype = rareOptions[Math.floor(Math.random() * rareOptions.length)];
            }
            
            // Filter genotypes that produce the target phenotype
            const matchingGenotypes = GENOTYPES.filter(g => getPhenotype(g) === targetPhenotype);
            
            // Return a random genotype from the matching ones
            if (matchingGenotypes.length === 0) {
                // Fallback to a basic genotype if no match found
                return GENOTYPES[Math.floor(Math.random() * GENOTYPES.length)];
            }
            return matchingGenotypes[Math.floor(Math.random() * matchingGenotypes.length)];
        }

        function getDisplayColor(phenotype) {
            // Randomly assign visual variants (about 30% chance)
            if (phenotype === 'Bay' && Math.random() < 0.3) {
                return 'Dark Bay';
            }
            if (phenotype === 'Gray' && Math.random() < 0.5) {
                return 'Gray Alt';
            }
            return phenotype;
        }

        function createHorse(name = null, useStarterGenotype = false, isStarter = false) {
            const genotype = useStarterGenotype ? randomStarterGenotype() : randomGenotype();
            const phenotype = getPhenotype(genotype);
            const displayColor = getDisplayColor(phenotype);
            const gender = Math.random() < 0.5 ? 'Stallion' : 'Mare';
            const temperament = generateRandomStat();
            const conformation = generateRandomStat();
            // Starter horses and purchased horses are breeding age, random 3-10
            // Available horses for breeding are also adult age
            const age = isStarter ? BREEDING_AGE : (BREEDING_AGE + Math.floor(Math.random() * 8));
            return {
                id: gameState.horseIdCounter++,
                name: name,
                genotype: genotype,
                phenotype: phenotype,
                displayColor: displayColor,
                gender: gender,
                temperament: temperament,
                conformation: conformation,
                age: age,
                health: STARTING_HEALTH,
                bredThisYear: false,  // Mares can only breed once per year
                competitionWins: []   // Array of {type, position, year}
            };
        }

        function createHorseWithGenotype(genotype, name = null, parent1 = null, parent2 = null) {
            const phenotype = getPhenotype(genotype);
            const displayColor = getDisplayColor(phenotype);
            const gender = Math.random() < 0.5 ? 'Stallion' : 'Mare';
            
            // Inherit stats from parents if available, otherwise random
            let temperament, conformation;
            if (parent1 && parent2) {
                temperament = inheritStat(parent1.temperament, parent2.temperament);
                conformation = inheritStat(parent1.conformation, parent2.conformation);
            } else {
                temperament = generateRandomStat();
                conformation = generateRandomStat();
            }
            
            // Store pedigree info - determine sire (male) and dam (female)
            let sire = null, dam = null;
            if (parent1 && parent2) {
                if (parent1.gender === 'Stallion') {
                    sire = extractPedigreeInfo(parent1);
                    dam = extractPedigreeInfo(parent2);
                } else {
                    sire = extractPedigreeInfo(parent2);
                    dam = extractPedigreeInfo(parent1);
                }
            }
            
            return {
                id: gameState.horseIdCounter++,
                name: name,
                genotype: genotype,
                phenotype: phenotype,
                displayColor: displayColor,
                gender: gender,
                temperament: temperament,
                conformation: conformation,
                age: 0,  // Foals start at age 0
                health: STARTING_HEALTH,
                bredThisYear: false,
                isHomebred: !!(parent1 && parent2),
                sire: sire,
                dam: dam,
                competitionWins: []
            };
        }
        
        function extractPedigreeInfo(horse) {
            // Extract relevant info for pedigree storage (up to 3 generations)
            return {
                name: horse.name,
                genotype: horse.genotype,
                displayColor: horse.displayColor,
                isHomebred: horse.isHomebred || false,
                sire: horse.sire || null,
                dam: horse.dam || null
            };
        }
        
        function getSaleValue(horse) {
            // If passed just a phenotype string (backwards compatibility)
            if (typeof horse === 'string') {
                return SALE_VALUES[horse] || 100;
            }
            // Full horse object with stats
            const baseValue = SALE_VALUES[horse.phenotype] || 100;
            const tempMultiplier = getStatMultiplier(horse.temperament);
            const confMultiplier = getStatMultiplier(horse.conformation);
            const goldMedals = horse.competitionWins?.filter(w => w.position === 1).length || 0;
            const medalBonus = goldMedals * GOLD_MEDAL_VALUE_BONUS;
            return Math.round(baseValue * tempMultiplier * confMultiplier) + medalBonus;
        }

        // ============================================
        // HORSE PREVIEW
        // ============================================
        function showHorsePreview(horse) {
            const modal = document.getElementById('horsePreviewModal');
            const img = document.getElementById('previewImage');
            const name = document.getElementById('previewName');
            const color = document.getElementById('previewColor');
            const genotype = document.getElementById('previewGenotype');

            const displayName = horse.displayColor === 'Gray Alt' ? 'Gray' : horse.displayColor;
            const genderIcon = horse.gender === 'Stallion' ? '‚ôÇ' : '‚ôÄ';
            const genderClass = horse.gender.toLowerCase();
            const saleValue = getSaleValue(horse);
            const tempLabel = getTemperamentLabel(horse.temperament);
            const confLabel = getConformationLabel(horse.conformation);
            const healthStatus = getHealthStatus(horse.health);
            const ageClass = horse.age < BREEDING_AGE ? 'foal' : horse.age < 8 ? 'young' : horse.age < 15 ? 'adult' : 'senior';
            const ageLabel = horse.age < BREEDING_AGE ? 'üçº Foal' : horse.age < 8 ? 'üå± Young' : horse.age < 15 ? 'üê¥ Adult' : 'üë¥ Senior';
            const homebredBadge = horse.isHomebred ? '<span class="homebred-badge">‚≠ê</span>' : '';
            const pedigreeInfo = horse.isHomebred ? `<div style="margin-top: 8px; font-size: 0.8rem; color: #666;">Sire: ${horse.sire?.name || 'Unknown'} ‚Ä¢ Dam: ${horse.dam?.name || 'Unknown'}</div>` : '';
            
            img.src = HORSE_IMAGES[horse.displayColor];
            img.alt = `${displayName} horse`;
            name.innerHTML = (horse.name || 'Horse ' + horse.id) + homebredBadge;
            color.innerHTML = `${displayName} <span class="horse-gender ${genderClass}">${genderIcon} ${horse.gender}</span>`;
            genotype.innerHTML = `
                <div class="horse-age ${ageClass}" style="margin-bottom: 5px;">${ageLabel} (Age ${horse.age})</div>
                <div class="health-bar-container" style="margin-bottom: 5px;">
                    <div class="health-bar ${healthStatus.class}" style="width: ${horse.health}%"></div>
                </div>
                <div class="health-label ${healthStatus.class}" style="margin-bottom: 8px;">${healthStatus.label} (${horse.health}%)</div>
                <div class="horse-stats" style="margin-bottom: 8px;">
                    <span class="stat-badge temp-${horse.temperament <= 3 ? 'low' : horse.temperament <= 6 ? 'mid' : 'high'}">${tempLabel} (${horse.temperament})</span>
                    <span class="stat-badge conf-${horse.conformation <= 3 ? 'low' : horse.conformation <= 6 ? 'mid' : 'high'}">${confLabel} (${horse.conformation})</span>
                </div>
                ${horse.genotype}<br>
                <span class="horse-value">Value: $${saleValue}</span>
                ${pedigreeInfo}
            `;

            modal.classList.add('active');
        }

        function closeHorsePreview() {
            document.getElementById('horsePreviewModal').classList.remove('active');
        }

        // ============================================
        // PEDIGREE SYSTEM
        // ============================================
        function showPedigree(horseId) {
            const horse = gameState.stable.find(h => h.id === horseId);
            if (!horse || !horse.isHomebred) return;
            
            const modal = document.getElementById('pedigreeModal');
            const horseInfo = document.getElementById('pedigreeHorseInfo');
            const treeContainer = document.getElementById('pedigreeTree');
            
            const displayName = horse.displayColor === 'Gray Alt' ? 'Gray' : horse.displayColor;
            const genderIcon = horse.gender === 'Stallion' ? '‚ôÇ' : '‚ôÄ';
            
            horseInfo.innerHTML = `
                <strong>${horse.name}</strong> ${genderIcon}<br>
                ${displayName} ‚Ä¢ ${horse.genotype}
            `;
            
            // Build pedigree tree
            treeContainer.innerHTML = buildPedigreeTree(horse);
            
            modal.classList.add('active');
        }
        
        function buildPedigreeTree(horse) {
            // Count generations available
            const generations = countGenerations(horse);
            
            let html = '<div style="display: flex; align-items: center; justify-content: center; gap: 10px;">';
            
            // Subject (the horse itself)
            html += `
                <div class="pedigree-generation">
                    <div class="generation-label">Subject</div>
                    ${renderPedigreeNode(horse, 'subject')}
                </div>
            `;
            
            // Parents (Gen 1)
            if (horse.sire || horse.dam) {
                html += '<div class="pedigree-connector"></div>';
                html += `
                    <div class="pedigree-generation">
                        <div class="generation-label">Parents</div>
                        ${renderPedigreeNode(horse.sire, 'sire')}
                        ${renderPedigreeNode(horse.dam, 'dam')}
                    </div>
                `;
                
                // Grandparents (Gen 2)
                const sireHasPedigree = horse.sire && (horse.sire.sire || horse.sire.dam);
                const damHasPedigree = horse.dam && (horse.dam.sire || horse.dam.dam);
                
                if (sireHasPedigree || damHasPedigree) {
                    html += '<div class="pedigree-connector"></div>';
                    html += `
                        <div class="pedigree-generation">
                            <div class="generation-label">Grandparents</div>
                            ${renderPedigreeNode(horse.sire?.sire, 'sire')}
                            ${renderPedigreeNode(horse.sire?.dam, 'dam')}
                            ${renderPedigreeNode(horse.dam?.sire, 'sire')}
                            ${renderPedigreeNode(horse.dam?.dam, 'dam')}
                        </div>
                    `;
                    
                    // Great-grandparents (Gen 3)
                    const hasGen3 = (horse.sire?.sire?.sire || horse.sire?.sire?.dam || 
                                     horse.sire?.dam?.sire || horse.sire?.dam?.dam ||
                                     horse.dam?.sire?.sire || horse.dam?.sire?.dam ||
                                     horse.dam?.dam?.sire || horse.dam?.dam?.dam);
                    
                    if (hasGen3) {
                        html += '<div class="pedigree-connector"></div>';
                        html += `
                            <div class="pedigree-generation">
                                <div class="generation-label">Great-Grandparents</div>
                                ${renderPedigreeNode(horse.sire?.sire?.sire, 'sire')}
                                ${renderPedigreeNode(horse.sire?.sire?.dam, 'dam')}
                                ${renderPedigreeNode(horse.sire?.dam?.sire, 'sire')}
                                ${renderPedigreeNode(horse.sire?.dam?.dam, 'dam')}
                                ${renderPedigreeNode(horse.dam?.sire?.sire, 'sire')}
                                ${renderPedigreeNode(horse.dam?.sire?.dam, 'dam')}
                                ${renderPedigreeNode(horse.dam?.dam?.sire, 'sire')}
                                ${renderPedigreeNode(horse.dam?.dam?.dam, 'dam')}
                            </div>
                        `;
                    }
                }
            }
            
            html += '</div>';
            return html;
        }
        
        function renderPedigreeNode(ancestor, type) {
            if (!ancestor) {
                return `
                    <div class="pedigree-node unknown">
                        <div class="node-name">Unknown</div>
                    </div>
                `;
            }
            
            const displayName = ancestor.displayColor === 'Gray Alt' ? 'Gray' : ancestor.displayColor;
            const homebredIcon = ancestor.isHomebred ? '<span class="homebred-badge">‚≠ê</span>' : '';
            
            return `
                <div class="pedigree-node ${type}">
                    <div class="node-name">${ancestor.name}${homebredIcon}</div>
                    <div class="node-color">${displayName}</div>
                    <div class="node-genotype">${ancestor.genotype}</div>
                </div>
            `;
        }
        
        function countGenerations(horse) {
            if (!horse.sire && !horse.dam) return 0;
            
            let maxGen = 1;
            if (horse.sire) {
                maxGen = Math.max(maxGen, 1 + countGenerations(horse.sire));
            }
            if (horse.dam) {
                maxGen = Math.max(maxGen, 1 + countGenerations(horse.dam));
            }
            return Math.min(maxGen, 3); // Cap at 3 generations
        }
        
        function closePedigree() {
            document.getElementById('pedigreeModal').classList.remove('active');
        }

        // ============================================
        // COMPETITION SYSTEM
        // ============================================
        function selectCompetitionType(type) {
            gameState.selectedCompetitionType = type;
            gameState.selectedCompetitionHorse = null;
            
            // Update UI for type selection
            document.querySelectorAll('.competition-type-card').forEach(card => {
                card.classList.toggle('selected', card.dataset.compType === type);
            });
            
            // Show horse selection
            renderCompetitionHorseSelect();
            updateEnterCompetitionButton();
        }
        
        function renderCompetitionHorseSelect() {
            const container = document.getElementById('competitionHorseSelect');
            
            if (!gameState.selectedCompetitionType || gameState.stable.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'flex';
            
            const horseOptions = gameState.stable.map(horse => {
                const displayName = horse.displayColor === 'Gray Alt' ? 'Gray' : horse.displayColor;
                const genderIcon = horse.gender === 'Stallion' ? '‚ôÇ' : '‚ôÄ';
                const score = gameState.selectedCompetitionType === 'halter' 
                    ? horse.conformation 
                    : (COLOR_RARITY_SCORES[horse.phenotype] || 1);
                const scoreLabel = gameState.selectedCompetitionType === 'halter' 
                    ? `Conf: ${score}` 
                    : `Rarity: ${score}`;
                const goldCount = horse.competitionWins?.filter(w => w.position === 1).length || 0;
                const medalDisplay = goldCount > 0 ? `<span class="medal-badge">ü•á${goldCount > 1 ? `<span class="medal-count">√ó${goldCount}</span>` : ''}</span>` : '';
                
                return `
                    <div class="competition-horse-option ${gameState.selectedCompetitionHorse?.id === horse.id ? 'selected' : ''}" 
                         data-horse-id="${horse.id}">
                        <div style="font-weight: 600;">${horse.name}${medalDisplay} ${genderIcon}</div>
                        <div style="font-size: 0.85rem; color: #666;">${displayName}</div>
                        <div style="font-size: 0.8rem; color: #3949AB; font-weight: 600;">${scoreLabel}</div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = `<p style="width: 100%; margin-bottom: 10px;"><strong>Select a horse to enter:</strong></p>` + horseOptions;
            
            container.querySelectorAll('.competition-horse-option').forEach(option => {
                option.addEventListener('click', () => {
                    selectCompetitionHorse(parseInt(option.dataset.horseId));
                });
            });
        }
        
        function selectCompetitionHorse(horseId) {
            gameState.selectedCompetitionHorse = gameState.stable.find(h => h.id === horseId);
            renderCompetitionHorseSelect();
            updateEnterCompetitionButton();
        }
        
        function updateEnterCompetitionButton() {
            const btn = document.getElementById('enterCompetitionBtn');
            const canEnter = gameState.selectedCompetitionType && 
                            gameState.selectedCompetitionHorse && 
                            gameState.money >= COMPETITION_ENTRY_FEE;
            btn.disabled = !canEnter;
        }
        
        function enterCompetition() {
            if (!gameState.selectedCompetitionType || !gameState.selectedCompetitionHorse) return;
            if (gameState.money < COMPETITION_ENTRY_FEE) {
                alert("Not enough money to enter competition!");
                return;
            }
            
            // Deduct entry fee
            gameState.money -= COMPETITION_ENTRY_FEE;
            updateMoneyDisplay();
            
            // Generate 5 random opponents
            const opponents = [];
            for (let i = 0; i < 5; i++) {
                opponents.push(createHorse(`Competitor ${i + 1}`, false, false));
            }
            
            // Calculate scores
            const playerHorse = gameState.selectedCompetitionHorse;
            const allHorses = [playerHorse, ...opponents];
            
            const scoredHorses = allHorses.map(horse => {
                let score;
                if (gameState.selectedCompetitionType === 'halter') {
                    // Halter: conformation + small random factor
                    score = horse.conformation + (Math.random() * 2 - 1);
                } else {
                    // Most Colorful: rarity score + small random factor
                    score = (COLOR_RARITY_SCORES[horse.phenotype] || 1) + (Math.random() * 1.5 - 0.75);
                }
                return { horse, score, isPlayer: horse.id === playerHorse.id };
            });
            
            // Sort by score descending
            scoredHorses.sort((a, b) => b.score - a.score);
            
            // Assign positions
            scoredHorses.forEach((entry, index) => {
                entry.position = index + 1;
            });
            
            // Store results
            gameState.lastCompetitionResults = {
                type: gameState.selectedCompetitionType,
                results: scoredHorses,
                opponents: opponents
            };
            
            // Award prizes and record wins
            const playerResult = scoredHorses.find(e => e.isPlayer);
            let reward = 0;
            if (playerResult.position <= 3) {
                reward = COMPETITION_PRIZES[playerResult.position];
                gameState.money += reward;
                gameState.totalEarnings += reward;
                updateMoneyDisplay();
                
                // Record the win
                if (!playerHorse.competitionWins) playerHorse.competitionWins = [];
                playerHorse.competitionWins.push({
                    type: gameState.selectedCompetitionType,
                    position: playerResult.position,
                    year: gameState.currentYear
                });
            }
            
            // Update competition stats for achievements
            updateCompetitionStats(playerResult.position);
            
            // Show results
            showCompetitionResults(reward, playerResult.position);
        }
        
        function showCompetitionResults(reward, playerPosition) {
            const modal = document.getElementById('competitionModal');
            const title = document.getElementById('competitionTitle');
            const summary = document.getElementById('competitionRewardSummary');
            const leaderboard = document.getElementById('resultsLeaderboard');
            
            const typeName = gameState.selectedCompetitionType === 'halter' ? 'üéÄ Halter Show' : 'üåà Most Colorful';
            title.textContent = `${typeName} Results`;
            
            // Show reward summary
            if (playerPosition <= 3) {
                const medal = playerPosition === 1 ? 'ü•á' : playerPosition === 2 ? 'ü•à' : 'ü•â';
                summary.innerHTML = `
                    <div style="font-size: 2rem;">${medal}</div>
                    <div>Your horse placed <strong>${playerPosition === 1 ? '1st' : playerPosition === 2 ? '2nd' : '3rd'}</strong>!</div>
                    <div class="reward-amount">+$${reward}</div>
                `;
            } else {
                summary.innerHTML = `
                    <div style="font-size: 1.5rem;">üòî</div>
                    <div>Your horse placed <strong>${playerPosition}th</strong></div>
                    <div style="color: #666;">Better luck next time!</div>
                `;
            }
            
            // Build leaderboard
            const results = gameState.lastCompetitionResults.results;
            leaderboard.innerHTML = results.map(entry => {
                const positionClass = entry.position === 1 ? 'gold' : entry.position === 2 ? 'silver' : entry.position === 3 ? 'bronze' : '';
                const positionEmoji = entry.position === 1 ? 'ü•á' : entry.position === 2 ? 'ü•à' : entry.position === 3 ? 'ü•â' : `${entry.position}th`;
                const playerClass = entry.isPlayer ? 'player-horse' : '';
                const displayName = entry.horse.displayColor === 'Gray Alt' ? 'Gray' : entry.horse.displayColor;
                const saleValue = getSaleValue(entry.horse);
                const scoreLabel = gameState.selectedCompetitionType === 'halter' 
                    ? `Conf: ${entry.horse.conformation}` 
                    : `Rarity: ${COLOR_RARITY_SCORES[entry.horse.phenotype] || 1}`;
                
                // Buy button for non-player horses
                const buyBtn = !entry.isPlayer && gameState.stable.length < MAX_STABLE_SIZE
                    ? `<button class="leaderboard-buy-btn" data-buy-horse="${entry.position}" ${gameState.money < saleValue ? 'disabled' : ''}>Buy $${saleValue}</button>`
                    : '';
                
                return `
                    <div class="leaderboard-entry ${positionClass} ${playerClass}">
                        <div class="leaderboard-position">${positionEmoji}</div>
                        <div class="leaderboard-horse-info">
                            <div class="leaderboard-horse-name">${entry.horse.name}${entry.isPlayer ? ' (You)' : ''}</div>
                            <div class="leaderboard-horse-details">${displayName} ‚Ä¢ ${scoreLabel}</div>
                        </div>
                        <div class="leaderboard-score">${entry.score.toFixed(1)} pts</div>
                        ${buyBtn}
                    </div>
                `;
            }).join('');
            
            // Add buy button listeners
            leaderboard.querySelectorAll('.leaderboard-buy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    buyCompetitionHorse(parseInt(btn.dataset.buyHorse));
                });
            });
            
            modal.classList.add('active');
        }
        
        function buyCompetitionHorse(position) {
            const entry = gameState.lastCompetitionResults.results.find(e => e.position === position);
            if (!entry || entry.isPlayer) return;
            
            const horse = entry.horse;
            const saleValue = getSaleValue(horse);
            
            if (gameState.money < saleValue) {
                alert("Not enough money!");
                return;
            }
            
            if (gameState.stable.length >= MAX_STABLE_SIZE) {
                alert("Stable is full!");
                return;
            }
            
            // Purchase the horse
            gameState.money -= saleValue;
            updateMoneyDisplay();
            
            // Add to stable with a naming modal
            showNamingModal(horse, (name) => {
                horse.name = name;
                horse.competitionWins = []; // Reset wins for new owner
                gameState.stable.push(horse);
                renderStable();
                renderStablePartners();
                renderCompetitionHorseSelect();
                
                // Update the leaderboard to show horse was bought
                closeCompetitionResults();
            });
        }
        
        function closeCompetitionResults() {
            document.getElementById('competitionModal').classList.remove('active');
            gameState.selectedCompetitionType = null;
            gameState.selectedCompetitionHorse = null;
            document.querySelectorAll('.competition-type-card').forEach(card => card.classList.remove('selected'));
            document.getElementById('competitionHorseSelect').style.display = 'none';
            updateEnterCompetitionButton();
            renderStable(); // Update stable to show new medals
        }
        
        function showMedalHistory(horseId) {
            const horse = gameState.stable.find(h => h.id === horseId);
            if (!horse || !horse.competitionWins || horse.competitionWins.length === 0) return;
            
            const modal = document.getElementById('medalHistoryModal');
            const title = document.getElementById('medalHistoryTitle');
            const list = document.getElementById('medalHistoryList');
            
            title.textContent = `üèÜ ${horse.name}'s Competition History`;
            
            list.innerHTML = horse.competitionWins.map(win => {
                const medal = win.position === 1 ? 'ü•á' : win.position === 2 ? 'ü•à' : 'ü•â';
                const place = win.position === 1 ? '1st' : win.position === 2 ? '2nd' : '3rd';
                const typeName = win.type === 'halter' ? 'Halter Show' : 'Most Colorful';
                return `
                    <div class="medal-history-entry">
                        ${medal} <strong>${place} Place</strong> - ${typeName} (Year ${win.year})
                    </div>
                `;
            }).join('');
            
            modal.classList.add('active');
        }
        
        function closeMedalHistory() {
            document.getElementById('medalHistoryModal').classList.remove('active');
        }
        
        function getGoldMedalCount(horse) {
            if (!horse.competitionWins) return 0;
            return horse.competitionWins.filter(w => w.position === 1).length;
        }

        // ============================================
        // ACHIEVEMENTS SYSTEM
        // ============================================
        function checkAchievements() {
            const newlyUnlocked = [];
            
            ACHIEVEMENTS.forEach(achievement => {
                if (!gameState.unlockedAchievements.includes(achievement.id)) {
                    if (achievement.check(gameState)) {
                        gameState.unlockedAchievements.push(achievement.id);
                        gameState.money += achievement.reward;
                        gameState.totalEarnings += achievement.reward;
                        newlyUnlocked.push(achievement);
                    }
                }
            });
            
            // Show notifications for new achievements
            newlyUnlocked.forEach((achievement, index) => {
                setTimeout(() => {
                    showAchievementToast(achievement);
                }, index * 500);
            });
            
            if (newlyUnlocked.length > 0) {
                updateMoneyDisplay();
                renderAchievements();
            }
        }
        
        function showAchievementToast(achievement) {
            const toast = document.createElement('div');
            toast.className = 'achievement-toast';
            toast.innerHTML = `
                <div class="toast-icon">${achievement.icon}</div>
                <div class="toast-content">
                    <div class="toast-title">üéâ ${achievement.name}</div>
                    <div class="toast-reward">+$${achievement.reward}</div>
                </div>
            `;
            document.body.appendChild(toast);
            
            // Remove after animation
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        function renderAchievements() {
            const grid = document.getElementById('achievementsGrid');
            const progress = document.getElementById('achievementProgress');
            
            if (!grid) return;
            
            const unlocked = gameState.unlockedAchievements.length;
            const total = ACHIEVEMENTS.length;
            progress.textContent = `${unlocked} / ${total} Unlocked`;
            
            grid.innerHTML = ACHIEVEMENTS.map(achievement => {
                const isUnlocked = gameState.unlockedAchievements.includes(achievement.id);
                return `
                    <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-name">${achievement.name}</div>
                        <div class="achievement-desc">${achievement.desc}</div>
                        <div class="achievement-reward">${isUnlocked ? '‚úì Claimed' : `+$${achievement.reward}`}</div>
                    </div>
                `;
            }).join('');
        }
        
        function updateBreedingStats(horse) {
            // Called when a new horse is bred
            gameState.totalBred++;
            
            // Track generation
            const generation = getHorseGeneration(horse);
            if (generation > gameState.maxGeneration) {
                gameState.maxGeneration = generation;
            }
            
            // Track best conformation
            if (horse.conformation > gameState.bestConformation) {
                gameState.bestConformation = horse.conformation;
            }
            
            // Track temperament extremes
            if (horse.temperament > gameState.calmestHorse) {
                gameState.calmestHorse = horse.temperament;
            }
            if (horse.temperament < gameState.spiritedHorse) {
                gameState.spiritedHorse = horse.temperament;
            }
            
            // Track colors bred
            if (!gameState.colorsBred.includes(horse.phenotype)) {
                gameState.colorsBred.push(horse.phenotype);
            }
            
            checkAchievements();
        }
        
        function getHorseGeneration(horse) {
            if (!horse.isHomebred) return 0;
            if (!horse.sire && !horse.dam) return 1;
            
            let sireGen = 0, damGen = 0;
            if (horse.sire?.isHomebred) {
                sireGen = 1 + (horse.sire.sire?.isHomebred || horse.sire.dam?.isHomebred ? 1 : 0);
                if (horse.sire.sire?.sire?.isHomebred || horse.sire.sire?.dam?.isHomebred ||
                    horse.sire.dam?.sire?.isHomebred || horse.sire.dam?.dam?.isHomebred) {
                    sireGen++;
                }
            }
            if (horse.dam?.isHomebred) {
                damGen = 1 + (horse.dam.sire?.isHomebred || horse.dam.dam?.isHomebred ? 1 : 0);
                if (horse.dam.sire?.sire?.isHomebred || horse.dam.sire?.dam?.isHomebred ||
                    horse.dam.dam?.sire?.isHomebred || horse.dam.dam?.dam?.isHomebred) {
                    damGen++;
                }
            }
            
            return 1 + Math.max(sireGen, damGen);
        }
        
        function updateCompetitionStats(position) {
            gameState.competitionsEntered++;
            if (position === 1) {
                gameState.goldMedals++;
            }
            checkAchievements();
        }

        // ============================================
        // UI RENDERING
        // ============================================
        function renderHorseCard(horse, showGenotype = true) {
            const imgSrc = HORSE_IMAGES[horse.displayColor];
            const displayName = horse.displayColor === 'Gray Alt' ? 'Gray' : horse.displayColor;
            const genderClass = horse.gender.toLowerCase();
            const genderIcon = horse.gender === 'Stallion' ? '‚ôÇ' : '‚ôÄ';
            const saleValue = getSaleValue(horse);
            const tempLabel = getTemperamentLabel(horse.temperament);
            const confLabel = getConformationLabel(horse.conformation);
            const ageClass = horse.age < BREEDING_AGE ? 'foal' : horse.age < 8 ? 'young' : horse.age < 15 ? 'adult' : 'senior';
            return `
                <div class="horse-icon clickable-preview" data-horse-id="${horse.id}"><img src="${imgSrc}" alt="${displayName} horse"></div>
                <div class="horse-label">${horse.name || 'Horse ' + horse.id}</div>
                <div class="horse-color">${displayName}</div>
                <span class="horse-gender ${genderClass}">${genderIcon} ${horse.gender}</span>
                <div class="horse-age ${ageClass}">Age ${horse.age}</div>
                <div class="horse-stats">
                    <span class="stat-badge temp-${horse.temperament <= 3 ? 'low' : horse.temperament <= 6 ? 'mid' : 'high'}">${tempLabel} (${horse.temperament})</span>
                    <span class="stat-badge conf-${horse.conformation <= 3 ? 'low' : horse.conformation <= 6 ? 'mid' : 'high'}">${confLabel} (${horse.conformation})</span>
                </div>
                ${showGenotype ? `<div class="horse-genotype">${horse.genotype}</div>` : ''}
                <div class="horse-value">Value: $${saleValue}</div>
            `;
        }

        function renderStarterHorses() {
            const container = document.getElementById('starterHorses');
            gameState.starterHorses = Array(5).fill(null).map(() => createHorse(null, true, true));

            container.innerHTML = gameState.starterHorses.map((horse, index) => `
                <div class="horse-card" data-index="${index}">
                    ${renderHorseCard(horse)}
                </div>
            `).join('');

            container.querySelectorAll('.horse-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (e.target.closest('.clickable-preview')) {
                        showHorsePreview(gameState.starterHorses[parseInt(card.dataset.index)]);
                        return;
                    }
                    selectStarterHorse(parseInt(card.dataset.index));
                });
            });
        }

        function selectStarterHorse(index) {
            gameState.selectedStarter = index;
            document.querySelectorAll('#starterHorses .horse-card').forEach((card, i) => {
                card.classList.toggle('selected', i === index);
            });
            document.getElementById('selectStarterBtn').disabled = false;
        }

        function renderStable() {
            const container = document.getElementById('stableList');

            if (gameState.stable.length === 0) {
                container.innerHTML = '<div class="empty-stable">Your stable is empty.</div>';
                return;
            }

            const stableCount = `<div class="stable-count">Stable: ${gameState.stable.length}/${MAX_STABLE_SIZE} horses</div>`;

            const stableFull = gameState.stable.length >= MAX_STABLE_SIZE 
                ? '<div class="stable-full-warning">‚ö†Ô∏è Your stable is full! Sell a horse to make room for breeding.</div>' 
                : '';

            const horseList = gameState.stable.map(horse => {
                const displayName = horse.displayColor === 'Gray Alt' ? 'Gray' : horse.displayColor;
                const genderClass = horse.gender.toLowerCase();
                const genderIcon = horse.gender === 'Stallion' ? '‚ôÇ' : '‚ôÄ';
                const saleValue = getSaleValue(horse);
                const tempLabel = getTemperamentLabel(horse.temperament);
                const confLabel = getConformationLabel(horse.conformation);
                const healthStatus = getHealthStatus(horse.health);
                const breedStatus = getBreedingStatus(horse);
                const ageClass = horse.age < BREEDING_AGE ? 'foal' : horse.age < 8 ? 'young' : horse.age < 15 ? 'adult' : 'senior';
                const ageLabel = horse.age < BREEDING_AGE ? 'üçº Foal' : horse.age < 8 ? 'üå± Young' : horse.age < 15 ? 'üê¥ Adult' : 'üë¥ Senior';
                const healthFull = horse.health >= 100;
                const canAffordFeed = gameState.money >= FEED_COST;
                const homebredBadge = horse.isHomebred ? '<span class="homebred-badge">‚≠ê</span>' : '';
                const pedigreeBtn = horse.isHomebred ? `<button class="btn-pedigree" data-pedigree-id="${horse.id}">üìú Pedigree</button>` : '';
                const goldCount = horse.competitionWins?.filter(w => w.position === 1).length || 0;
                const medalBadge = goldCount > 0 ? `<span class="medal-badge" data-medal-id="${horse.id}">ü•á${goldCount > 1 ? `<span class="medal-count">√ó${goldCount}</span>` : ''}</span>` : '';
                return `
                <div class="stable-horse ${gameState.selectedStableHorse?.id === horse.id ? 'selected' : ''}" 
                     data-id="${horse.id}">
                    <div class="horse-icon clickable-preview" data-horse-id="${horse.id}"><img src="${HORSE_IMAGES[horse.displayColor]}" alt="${displayName} horse"></div>
                    <div class="stable-horse-info">
                        <div class="stable-horse-name">${horse.name}${homebredBadge}${medalBadge} <span class="horse-gender ${genderClass}">${genderIcon}</span>${pedigreeBtn}</div>
                        <div class="stable-horse-details">${displayName} ‚Ä¢ ${tempLabel} ‚Ä¢ ${confLabel}</div>
                        <div class="horse-age ${ageClass}">${ageLabel} (Age ${horse.age})</div>
                        <div class="health-bar-container">
                            <div class="health-bar ${healthStatus.class}" style="width: ${horse.health}%"></div>
                        </div>
                        <div class="health-label ${healthStatus.class}">${healthStatus.label} (${horse.health}%)</div>
                        <span class="breeding-status ${breedStatus.canBreed ? 'can-breed' : 'cannot-breed'}">${breedStatus.reason}</span>
                        <div class="care-buttons">
                            <button class="btn-care btn-feed" data-feed-id="${horse.id}" ${healthFull || !canAffordFeed ? 'disabled' : ''}>ü•ï Feed ($${FEED_COST})</button>
                            <button class="btn-care btn-groom" data-groom-id="${horse.id}" ${healthFull ? 'disabled' : ''}>‚ú® Groom</button>
                        </div>
                    </div>
                    <button class="btn btn-sell" data-sell-id="${horse.id}">Sell ($${saleValue})</button>
                </div>
            `}).join('');

            container.innerHTML = stableCount + stableFull + horseList;

            container.querySelectorAll('.stable-horse').forEach(el => {
                el.addEventListener('click', (e) => {
                    // Don't select if clicking the sell button
                    if (e.target.classList.contains('btn-sell')) return;
                    // Show preview if clicking the horse icon
                    if (e.target.closest('.clickable-preview')) {
                        const horse = gameState.stable.find(h => h.id === parseInt(el.dataset.id));
                        showHorsePreview(horse);
                        return;
                    }
                    selectStableHorse(parseInt(el.dataset.id));
                });
            });

            container.querySelectorAll('.btn-sell').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    sellHorse(parseInt(btn.dataset.sellId));
                });
            });
            
            container.querySelectorAll('.btn-feed').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    feedHorse(parseInt(btn.dataset.feedId));
                });
            });
            
            container.querySelectorAll('.btn-groom').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    groomHorse(parseInt(btn.dataset.groomId));
                });
            });
            
            container.querySelectorAll('.btn-pedigree').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showPedigree(parseInt(btn.dataset.pedigreeId));
                });
            });
            
            container.querySelectorAll('.medal-badge').forEach(badge => {
                badge.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showMedalHistory(parseInt(badge.dataset.medalId));
                });
            });
        }

        function renderStablePartners() {
            const container = document.getElementById('stablePartnerList');

            if (gameState.stable.length < 2) {
                container.innerHTML = '<div class="empty-stable">You need at least 2 horses to breed within your stable.</div>';
                return;
            }

            const availablePartners = gameState.stable.filter(h => h.id !== gameState.selectedStableHorse?.id);

            container.innerHTML = availablePartners.map(horse => {
                const displayName = horse.displayColor === 'Gray Alt' ? 'Gray' : horse.displayColor;
                const genderClass = horse.gender.toLowerCase();
                const genderIcon = horse.gender === 'Stallion' ? '‚ôÇ' : '‚ôÄ';
                const tempLabel = getTemperamentLabel(horse.temperament);
                const confLabel = getConformationLabel(horse.conformation);
                const breedStatus = getBreedingStatus(horse);
                const ageClass = horse.age < BREEDING_AGE ? 'foal' : horse.age < 8 ? 'young' : horse.age < 15 ? 'adult' : 'senior';
                return `
                <div class="stable-horse ${gameState.selectedPartner?.id === horse.id && gameState.partnerSource === 'stable' ? 'selected' : ''}" 
                     data-id="${horse.id}">
                    <div class="horse-icon clickable-preview" data-horse-id="${horse.id}"><img src="${HORSE_IMAGES[horse.displayColor]}" alt="${displayName} horse"></div>
                    <div class="stable-horse-info">
                        <div class="stable-horse-name">${horse.name} <span class="horse-gender ${genderClass}">${genderIcon}</span></div>
                        <div class="stable-horse-details">${displayName} ‚Ä¢ ${tempLabel} ‚Ä¢ ${confLabel}</div>
                        <div class="horse-age ${ageClass}">Age ${horse.age}</div>
                        <span class="breeding-status ${breedStatus.canBreed ? 'can-breed' : 'cannot-breed'}">${breedStatus.reason}</span>
                    </div>
                </div>
            `}).join('');

            container.querySelectorAll('.stable-horse').forEach(el => {
                el.addEventListener('click', (e) => {
                    // Show preview if clicking the horse icon
                    if (e.target.closest('.clickable-preview')) {
                        const horse = gameState.stable.find(h => h.id === parseInt(el.dataset.id));
                        showHorsePreview(horse);
                        return;
                    }
                    selectStablePartner(parseInt(el.dataset.id));
                });
            });
        }

        function selectStableHorse(id) {
            const horse = gameState.stable.find(h => h.id === id);
            gameState.selectedStableHorse = horse;

            // Clear partner if it was the same horse
            if (gameState.selectedPartner?.id === id && gameState.partnerSource === 'stable') {
                gameState.selectedPartner = null;
                gameState.partnerSource = null;
            }

            renderStable();
            renderStablePartners();
            updateBreedingSlots();
            updateBreedButton();
        }

        function selectStablePartner(id) {
            const horse = gameState.stable.find(h => h.id === id);
            if (horse.id === gameState.selectedStableHorse?.id) return;

            gameState.selectedPartner = horse;
            gameState.partnerSource = 'stable';

            // Clear outside selection
            document.querySelectorAll('#availableHorses .horse-card').forEach(card => {
                card.classList.remove('selected');
            });

            renderStablePartners();
            updateBreedingSlots();
            updateBreedButton();
        }

        function renderAvailableHorses() {
            const container = document.getElementById('availableHorses');
            
            // Generate 5 horses but ensure at least 1 mare and 1 stallion
            gameState.availableHorses = [];
            
            // Generate first 5 horses randomly
            for (let i = 0; i < 5; i++) {
                gameState.availableHorses.push(createHorse(null, false));
            }
            
            // Check gender balance
            const mares = gameState.availableHorses.filter(h => h.gender === 'Mare');
            const stallions = gameState.availableHorses.filter(h => h.gender === 'Stallion');
            
            // If no mares, change one stallion to mare
            if (mares.length === 0 && stallions.length > 0) {
                gameState.availableHorses[0].gender = 'Mare';
            }
            // If no stallions, change one mare to stallion
            if (stallions.length === 0 && mares.length > 0) {
                gameState.availableHorses[0].gender = 'Stallion';
            }

            container.innerHTML = gameState.availableHorses.map((horse, index) => {
                const saleValue = getSaleValue(horse);
                const canAfford = gameState.money >= saleValue;
                const stableFull = gameState.stable.length >= MAX_STABLE_SIZE;
                return `
                <div class="horse-card" data-index="${index}">
                    ${renderHorseCard(horse)}
                    <div class="horse-card-actions">
                        <button class="btn-breed-partner" data-breed-index="${index}">Breed</button>
                        <button class="btn-buy ${!canAfford || stableFull ? 'disabled' : ''}" 
                                data-buy-index="${index}" 
                                ${!canAfford || stableFull ? 'disabled' : ''}>
                            Buy ($${saleValue})
                        </button>
                    </div>
                </div>
            `}).join('');

            // Add click handlers for horse preview
            container.querySelectorAll('.horse-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    // Don't trigger if clicking buttons
                    if (e.target.closest('.btn-breed-partner') || e.target.closest('.btn-buy')) return;
                    if (e.target.closest('.clickable-preview')) {
                        showHorsePreview(gameState.availableHorses[parseInt(card.dataset.index)]);
                        return;
                    }
                });
            });
            
            // Add breed button handlers
            container.querySelectorAll('.btn-breed-partner').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    selectAvailableHorse(parseInt(btn.dataset.breedIndex));
                });
            });
            
            // Add buy button handlers
            container.querySelectorAll('.btn-buy').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    buyHorse(parseInt(btn.dataset.buyIndex));
                });
            });
            
            updateRefreshButton();
        }
        
        function buyHorse(index) {
            const horse = gameState.availableHorses[index];
            if (!horse) return;
            
            const saleValue = getSaleValue(horse);
            
            // Check if player can afford it and has stable space
            if (gameState.money < saleValue) {
                alert("You don't have enough money to buy this horse!");
                return;
            }
            if (gameState.stable.length >= MAX_STABLE_SIZE) {
                alert("Your stable is full! Sell a horse first.");
                return;
            }
            
            // Deduct money
            gameState.money -= saleValue;
            updateMoneyDisplay();
            
            // Show naming modal and add to stable
            showNamingModal(horse, (name) => {
                horse.name = name;
                gameState.stable.push(horse);
                
                // Remove from available horses and regenerate
                gameState.availableHorses.splice(index, 1);
                
                // Add a new horse to replace
                const newHorse = createHorse(null, false);
                gameState.availableHorses.push(newHorse);
                
                renderAvailableHorses();
                renderStable();
                renderStablePartners();
            });
        }
        
        function updateRefreshButton() {
            const btn = document.getElementById('refreshHorsesBtn');
            const countSpan = document.getElementById('refreshCount');
            countSpan.textContent = gameState.refreshesRemaining;
            btn.disabled = gameState.refreshesRemaining <= 0;
        }
        
        function refreshHorses() {
            if (gameState.refreshesRemaining > 0) {
                gameState.refreshesRemaining--;
                renderAvailableHorses();
                
                // Clear partner selection if it was from outside
                if (gameState.partnerSource === 'outside') {
                    gameState.selectedPartner = null;
                    gameState.partnerSource = null;
                    updateBreedingSlots();
                    updateBreedButton();
                }
            }
        }

        function selectAvailableHorse(index) {
            const horse = gameState.availableHorses[index];
            gameState.selectedPartner = horse;
            gameState.partnerSource = 'outside';

            document.querySelectorAll('#availableHorses .horse-card').forEach((card, i) => {
                card.classList.toggle('selected', i === index);
            });

            // Clear stable partner selection
            renderStablePartners();
            updateBreedingSlots();
            updateBreedButton();
        }

        function updateBreedingSlots() {
            const slot1 = document.getElementById('breedingSlot1');
            const slot2 = document.getElementById('breedingSlot2');

            if (gameState.selectedStableHorse) {
                const displayName1 = gameState.selectedStableHorse.displayColor === 'Gray Alt' ? 'Gray' : gameState.selectedStableHorse.displayColor;
                const genderIcon1 = gameState.selectedStableHorse.gender === 'Stallion' ? '‚ôÇ' : '‚ôÄ';
                const genderClass1 = gameState.selectedStableHorse.gender.toLowerCase();
                slot1.innerHTML = `
                    <div class="horse-icon"><img src="${HORSE_IMAGES[gameState.selectedStableHorse.displayColor]}" alt="${displayName1} horse"></div>
                    <div class="horse-label">${gameState.selectedStableHorse.name}</div>
                    <div class="horse-color">${displayName1}</div>
                    <span class="horse-gender ${genderClass1}">${genderIcon1} ${gameState.selectedStableHorse.gender}</span>
                `;
                slot1.classList.add('filled');
            } else {
                slot1.innerHTML = '<p style="color: var(--warm-brown);">Select from Stable</p>';
                slot1.classList.remove('filled');
            }

            if (gameState.selectedPartner) {
                const displayName2 = gameState.selectedPartner.displayColor === 'Gray Alt' ? 'Gray' : gameState.selectedPartner.displayColor;
                const genderIcon2 = gameState.selectedPartner.gender === 'Stallion' ? '‚ôÇ' : '‚ôÄ';
                const genderClass2 = gameState.selectedPartner.gender.toLowerCase();
                slot2.innerHTML = `
                    <div class="horse-icon"><img src="${HORSE_IMAGES[gameState.selectedPartner.displayColor]}" alt="${displayName2} horse"></div>
                    <div class="horse-label">${gameState.selectedPartner.name || 'Horse ' + gameState.selectedPartner.id}</div>
                    <div class="horse-color">${displayName2}</div>
                    <span class="horse-gender ${genderClass2}">${genderIcon2} ${gameState.selectedPartner.gender}</span>
                `;
                slot2.classList.add('filled');
            } else {
                slot2.innerHTML = '<p style="color: var(--warm-brown);">Select Partner</p>';
                slot2.classList.remove('filled');
            }
        }

        function updateBreedButton() {
            const btn = document.getElementById('breedBtn');
            const stableFull = gameState.stable.length >= MAX_STABLE_SIZE;
            
            // Check if both horses are selected and they have opposite genders
            const hasValidPair = gameState.selectedStableHorse && gameState.selectedPartner &&
                                 gameState.selectedStableHorse.gender !== gameState.selectedPartner.gender;
            
            btn.disabled = !(hasValidPair && !stableFull);
            
            // Update button text to show why it's disabled
            if (gameState.selectedStableHorse && gameState.selectedPartner && 
                gameState.selectedStableHorse.gender === gameState.selectedPartner.gender) {
                btn.textContent = 'Need ‚ôÇ + ‚ôÄ to Breed';
            } else {
                btn.textContent = 'Breed Horses';
            }
        }

        function feedHorse(id) {
            const horse = gameState.stable.find(h => h.id === id);
            if (!horse) return;
            
            if (gameState.money < FEED_COST) {
                alert("Not enough money to feed this horse!");
                return;
            }
            
            if (horse.health >= 100) {
                alert("This horse is already at full health!");
                return;
            }
            
            gameState.money -= FEED_COST;
            horse.health = Math.min(100, horse.health + FEED_HEALTH_BOOST);
            
            updateMoneyDisplay();
            renderStable();
            renderStablePartners();
        }
        
        function groomHorse(id) {
            const horse = gameState.stable.find(h => h.id === id);
            if (!horse) return;
            
            if (horse.health >= 100) {
                alert("This horse is already at full health!");
                return;
            }
            
            horse.health = Math.min(100, horse.health + GROOM_HEALTH_BOOST);
            
            renderStable();
            renderStablePartners();
        }
        
        function advanceYear() {
            // Check if any horses are unhealthy
            const unhealthyHorses = gameState.stable.filter(h => h.health < HEALTHY_THRESHOLD);
            
            if (unhealthyHorses.length > 0) {
                const names = unhealthyHorses.map(h => h.name).join(', ');
                alert(`Cannot advance year! The following horses need care (health below ${HEALTHY_THRESHOLD}%): ${names}`);
                return;
            }
            
            // Advance the year
            gameState.currentYear++;
            document.getElementById('yearDisplay').textContent = gameState.currentYear;
            
            // Age all horses and decay health
            const retiredHorses = [];
            gameState.stable.forEach(horse => {
                horse.age++;
                horse.health = Math.max(0, horse.health - HEALTH_DECAY_PER_YEAR);
                horse.bredThisYear = false;  // Reset breeding cooldown for mares
                
                // Check for retirement
                if (horse.age >= MAX_AGE) {
                    retiredHorses.push(horse);
                }
            });
            
            // Remove retired horses
            if (retiredHorses.length > 0) {
                const names = retiredHorses.map(h => h.name).join(', ');
                alert(`üê¥ The following horses have retired (age ${MAX_AGE}): ${names}. Thank you for the memories!`);
                gameState.stable = gameState.stable.filter(h => h.age < MAX_AGE);
                
                // Clear selections if retired horse was selected
                retiredHorses.forEach(retired => {
                    if (gameState.selectedStableHorse?.id === retired.id) {
                        gameState.selectedStableHorse = null;
                    }
                    if (gameState.selectedPartner?.id === retired.id && gameState.partnerSource === 'stable') {
                        gameState.selectedPartner = null;
                        gameState.partnerSource = null;
                    }
                });
            }
            
            // Refresh available horses (they change each year)
            generateAvailableHorses();
            renderAvailableHorses();
            
            renderStable();
            renderStablePartners();
            updateBreedingSlots();
            updateBreedButton();
        }

        function sellHorse(id) {
            // Find the horse to get its sale value
            const horse = gameState.stable.find(h => h.id === id);
            if (horse) {
                const saleValue = getSaleValue(horse);
                gameState.money += saleValue;
                gameState.totalEarnings += saleValue;
                updateMoneyDisplay();
            }
            
            // Remove from stable
            gameState.stable = gameState.stable.filter(h => h.id !== id);

            // Clear selections if the sold horse was selected
            if (gameState.selectedStableHorse?.id === id) {
                gameState.selectedStableHorse = null;
            }
            if (gameState.selectedPartner?.id === id && gameState.partnerSource === 'stable') {
                gameState.selectedPartner = null;
                gameState.partnerSource = null;
            }

            renderStable();
            renderStablePartners();
            renderAvailableHorses(); // Re-render to update buy button states
            updateBreedingSlots();
            updateBreedButton();
        }
        
        function updateMoneyDisplay() {
            document.getElementById('moneyDisplay').textContent = gameState.money.toLocaleString();
            
            // Update tier display
            const currentTier = getCurrentTier();
            const nextTier = getNextTier();
            
            const tierDisplay = document.getElementById('tierDisplay');
            tierDisplay.innerHTML = `${currentTier.icon} ${currentTier.name}`;
            tierDisplay.style.color = currentTier.color;
            
            const tierProgress = document.getElementById('tierProgress');
            if (nextTier) {
                const remaining = nextTier.minMoney - gameState.totalEarnings;
                tierProgress.textContent = `$${remaining.toLocaleString()} to ${nextTier.name}`;
            } else {
                tierProgress.textContent = 'Max tier reached!';
            }
        }

        function clearBreedingSelection() {
            gameState.selectedStableHorse = null;
            gameState.selectedPartner = null;
            gameState.partnerSource = null;

            renderStable();
            renderStablePartners();
            document.querySelectorAll('#availableHorses .horse-card').forEach(card => {
                card.classList.remove('selected');
            });
            updateBreedingSlots();
            updateBreedButton();
        }

        // Temperament mission options
        const TEMP_MISSIONS = [
            { target: 'Calm', minScore: 7, reward: 100 },
            { target: 'Spirited', maxScore: 3, reward: 100 },
            { target: 'Very Calm', minScore: 9, reward: 175 },
            { target: 'Very Spirited', maxScore: 2, reward: 175 }
        ];
        
        // Conformation mission options
        const CONF_MISSIONS = [
            { target: 'Good (7+)', minScore: 7, reward: 100 },
            { target: 'Excellent (8+)', minScore: 8, reward: 150 },
            { target: 'Superior (10)', minScore: 10, reward: 300 }
        ];

        // Tiered color missions - easier ones more common early game
        const COLOR_MISSIONS_EASY = [
            'Bay', 'Black', 'Chestnut'
        ];
        
        const COLOR_MISSIONS_MEDIUM = [
            'Buckskin', 'Palomino', 'Smoky Black',
            'Bay Roan', 'Blue Roan', 'Red Roan',
            'Bay Tobiano', 'Black Tobiano', 'Chestnut Tobiano'
        ];
        
        const COLOR_MISSIONS_HARD = [
            'Double Dilute',
            'Gray Tobiano',
            'Buckskin Tobiano', 'Palomino Tobiano',
            'Roan Tobiano'
        ];
        
        // Hints for each color mission
        const COLOR_HINTS = {
            // Easy
            'Bay': "The classic look! Needs at least one dominant Extension (E) and one dominant Agouti (A).",
            'Black': "Pure darkness! Needs dominant Extension (E) and two recessive agouti (aa) to remove the bay pattern.",
            'Chestnut': "Red beauty! Needs two recessive extension genes (ee). Agouti doesn't matter on chestnuts!",
            // Medium
            'Buckskin': "A golden bay! Combine Bay genetics (E_, A_) with one Cream gene (Cr).",
            'Palomino': "Golden! Combine Chestnut (ee) with one Cream gene (Cr).",
            'Smoky Black': "A subtle shimmer! Combine Black (E_, aa) with one Cream gene (Cr).",
            'Bay Roan': "White hairs mixed in! Bay (E_, A_) plus at least one Roan gene (Rn).",
            'Blue Roan': "Stunning steel blue! Black (E_, aa) plus at least one Roan gene (Rn).",
            'Red Roan': "Strawberry! Chestnut (ee) plus at least one Roan gene (Rn).",
            'Bay Tobiano': "Spotted bay! Bay (E_, A_) plus at least one Tobiano gene (To).",
            'Black Tobiano': "Spotted black! Black (E_, aa) plus at least one Tobiano gene (To).",
            'Chestnut Tobiano': "Spotted red! Chestnut (ee) plus at least one Tobiano gene (To).",
            // Hard
            'Double Dilute': "Two Cream genes! Breeds Cremello (ee + CrCr), Perlino (E_, A_ + CrCr), or Smoky Cream (E_, aa + CrCr).",
            'Gray Tobiano': "Rare combo! Needs Gray gene (G) plus Tobiano (To). Gray will eventually turn the coat white.",
            'Buckskin Tobiano': "Spotted gold! Bay + one Cream + Tobiano (E_, A_, Cr, To).",
            'Palomino Tobiano': "Golden spots! Chestnut + one Cream + Tobiano (ee, Cr, To).",
            'Roan Tobiano': "Two patterns! Any base color with both Roan (Rn) and Tobiano (To)."
        };
        
        // Hints for conformation missions
        const CONF_HINTS = {
            'Good (7+)': "Breed horses with decent conformation scores. Higher conformation parents tend to produce higher conformation foals!",
            'Excellent (8+)': "Look for parents with high conformation (7+). The foal inherits from both parents with some variation.",
            'Superior (10)': "The perfect horse! Breed your highest conformation horses together and hope for luck. Very rare!"
        };

        function generateColorMission() {
            // Weight mission difficulty based on player progress
            let missionPool;
            const tier = getCurrentTier();
            
            if (tier.name === 'Starter' || tier.name === 'Bronze') {
                // Early game: mostly easy, some medium
                const rand = Math.random();
                if (rand < 0.6) {
                    missionPool = COLOR_MISSIONS_EASY;
                } else {
                    missionPool = COLOR_MISSIONS_MEDIUM;
                }
            } else if (tier.name === 'Silver' || tier.name === 'Gold') {
                // Mid game: mix of medium and hard
                const rand = Math.random();
                if (rand < 0.3) {
                    missionPool = COLOR_MISSIONS_EASY;
                } else if (rand < 0.7) {
                    missionPool = COLOR_MISSIONS_MEDIUM;
                } else {
                    missionPool = COLOR_MISSIONS_HARD;
                }
            } else {
                // Late game: mostly hard
                const rand = Math.random();
                if (rand < 0.2) {
                    missionPool = COLOR_MISSIONS_MEDIUM;
                } else {
                    missionPool = COLOR_MISSIONS_HARD;
                }
            }
            
            gameState.mission = missionPool[Math.floor(Math.random() * missionPool.length)];
            document.getElementById('missionTarget').textContent = gameState.mission;
            document.getElementById('missionReward').textContent = MISSION_REWARDS[gameState.mission] || 100;
            document.getElementById('colorMission').classList.remove('completed');
            
            // Update hint
            const hint = COLOR_HINTS[gameState.mission] || "Breed a horse with this color!";
            document.getElementById('colorHintPopup').textContent = hint;
        }

        function generateConfMission() {
            gameState.missionConformation = CONF_MISSIONS[Math.floor(Math.random() * CONF_MISSIONS.length)];
            document.getElementById('missionConfTarget').textContent = gameState.missionConformation.target;
            document.getElementById('missionConfReward').textContent = gameState.missionConformation.reward;
            document.getElementById('confMission').classList.remove('completed');
            
            // Update hint
            const hint = CONF_HINTS[gameState.missionConformation.target] || "Breed a horse with high conformation!";
            document.getElementById('confHintPopup').textContent = hint;
        }

        function generateMission() {
            // Generate color and conformation missions (no more temperament)
            generateColorMission();
            generateConfMission();
            document.getElementById('successMessage').style.display = 'none';
        }
        
        // ============================================
        // HINTS & GUIDE SYSTEM
        // ============================================
        function toggleHint(hintId) {
            const popup = document.getElementById(hintId);
            const isActive = popup.classList.contains('active');
            
            // Close all hints first
            document.querySelectorAll('.hint-popup').forEach(p => p.classList.remove('active'));
            
            // Toggle this one
            if (!isActive) {
                popup.classList.add('active');
            }
        }
        
        function showGuide() {
            document.getElementById('guideModal').classList.add('active');
        }
        
        function closeGuide() {
            document.getElementById('guideModal').classList.remove('active');
        }
        
        function showIntro() {
            document.getElementById('introModal').classList.add('active');
        }
        
        function closeIntro() {
            document.getElementById('introModal').classList.remove('active');
        }

        // ============================================
        // AI CHAT SYSTEM
        // ============================================
        let apiKey = localStorage.getItem('horseGameApiKey') || '';
        let chatHistory = [];
        
        const GENETICS_SYSTEM_PROMPT = `You are a friendly horse genetics advisor for a breeding game. You help players understand horse color genetics and breeding strategies.

The game uses these genes:
- Extension (E): E_ = can produce black pigment, ee = chestnut (red only, no black)
- Agouti (A): A_ = restricts black to points (creates bay), aa = black all over. Only visible on E_ horses.
- Cream (Cr): Single copy dilutes red to gold and black slightly. CrCr = double dilute (cremello, perlino, smoky cream)
- Gray (G): Dominant, causes progressive graying. G_ = will turn gray over time.
- Roan (Rn): Dominant, white hairs mixed throughout coat. Rn_ = roan pattern.
- Tobiano (To): Dominant, white spotting pattern. To_ = tobiano pattern.

Base colors:
- Bay = E_ + A_ (brown body, black points)
- Black = E_ + aa (all black)
- Chestnut = ee (red, agouti doesn't matter)

With cream:
- Buckskin = Bay + one Cr
- Palomino = Chestnut + one Cr  
- Smoky Black = Black + one Cr
- Cremello = Chestnut + CrCr
- Perlino = Bay + CrCr
- Smoky Cream = Black + CrCr

Roan adds "Roan" to any base (Bay Roan, Blue Roan from black, Red Roan from chestnut).
Tobiano adds "Tobiano" to any base.
Gray overrides visual color over time but genetics remain.

Keep responses concise (2-3 short paragraphs max). Be encouraging and helpful. If asked about the player's specific horses or missions, use the context provided.`;

        function initializeChat() {
            // Check for saved API key
            if (apiKey) {
                document.getElementById('apiKeyInput').value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                updateApiKeyStatus(true);
                enableChat();
            }
        }
        
        function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();
            
            if (key && key.startsWith('sk-ant-')) {
                apiKey = key;
                localStorage.setItem('horseGameApiKey', key);
                input.value = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                updateApiKeyStatus(true);
                enableChat();
                addChatMessage('system', '‚úÖ API key saved! You can now ask me about genetics.');
            } else if (key === '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') {
                // Key already saved, do nothing
                return;
            } else {
                updateApiKeyStatus(false);
                addChatMessage('error', '‚ùå Invalid API key. It should start with "sk-ant-"');
            }
        }
        
        function updateApiKeyStatus(connected) {
            const status = document.getElementById('apiKeyStatus');
            if (connected) {
                status.textContent = 'üü¢ API key connected';
                status.className = 'api-key-status connected';
            } else {
                status.textContent = 'üî¥ Invalid or missing API key';
                status.className = 'api-key-status disconnected';
            }
        }
        
        function enableChat() {
            document.getElementById('chatInput').disabled = false;
            document.getElementById('sendChatBtn').disabled = false;
        }
        
        function disableChat() {
            document.getElementById('chatInput').disabled = true;
            document.getElementById('sendChatBtn').disabled = true;
        }
        
        function addChatMessage(type, content) {
            const container = document.getElementById('chatMessages');
            const message = document.createElement('div');
            message.className = `chat-message ${type}`;
            message.textContent = content;
            container.appendChild(message);
            container.scrollTop = container.scrollHeight;
            return message;
        }
        
        function getGameContext() {
            // Build context about current game state
            let context = "";
            
            // Current missions
            if (gameState.mission) {
                context += `Current color mission: Breed a ${gameState.mission} horse.\n`;
            }
            if (gameState.missionConformation) {
                context += `Current conformation mission: ${gameState.missionConformation.target}.\n`;
            }
            
            // Stable horses
            if (gameState.stable.length > 0) {
                context += `\nPlayer's stable (${gameState.stable.length} horses):\n`;
                gameState.stable.forEach(horse => {
                    context += `- ${horse.name}: ${horse.phenotype}, ${horse.gender}, genotype ${horse.genotype}, age ${horse.age}\n`;
                });
            }
            
            // Available horses
            if (gameState.availableHorses.length > 0) {
                context += `\nAvailable breeding partners:\n`;
                gameState.availableHorses.slice(0, 5).forEach(horse => {
                    context += `- ${horse.name}: ${horse.phenotype}, ${horse.gender}, genotype ${horse.genotype}\n`;
                });
            }
            
            return context;
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const userMessage = input.value.trim();
            
            if (!userMessage || !apiKey) return;
            
            input.value = '';
            addChatMessage('user', userMessage);
            
            // Add loading indicator
            const loadingMsg = addChatMessage('loading', 'Thinking...');
            
            // Build messages array with context
            const gameContext = getGameContext();
            const contextMessage = gameContext ? `\n\n[CURRENT GAME STATE]\n${gameContext}` : '';
            
            chatHistory.push({ role: 'user', content: userMessage + contextMessage });
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 500,
                        system: GENETICS_SYSTEM_PROMPT,
                        messages: chatHistory.slice(-10) // Keep last 10 messages for context
                    })
                });
                
                // Remove loading message
                loadingMsg.remove();
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API error: ${response.status}`);
                }
                
                const data = await response.json();
                const assistantMessage = data.content[0].text;
                
                chatHistory.push({ role: 'assistant', content: assistantMessage });
                addChatMessage('assistant', assistantMessage);
                
            } catch (error) {
                loadingMsg.remove();
                console.error('Chat error:', error);
                
                if (error.message.includes('401') || error.message.includes('invalid')) {
                    addChatMessage('error', '‚ùå API key invalid or expired. Please check your key.');
                    apiKey = '';
                    localStorage.removeItem('horseGameApiKey');
                    updateApiKeyStatus(false);
                    disableChat();
                } else {
                    addChatMessage('error', `‚ùå Error: ${error.message}`);
                }
                
                // Remove the failed message from history
                chatHistory.pop();
            }
        }
        
        function handleSuggestionClick(question) {
            document.getElementById('chatInput').value = question;
            sendChatMessage();
        }

        function checkMission(horse) {
            const phenotype = horse.phenotype;
            let totalReward = 0;
            let completedMissions = [];
            let colorComplete = false;
            let confComplete = false;
            
            // Check color mission
            if (!document.getElementById('colorMission').classList.contains('completed')) {
                switch(gameState.mission) {
                    case 'Double Dilute':
                        colorComplete = phenotype.includes('Cremello') || phenotype.includes('Perlino') || phenotype.includes('Smoky Cream');
                        break;
                    case 'Roan Tobiano':
                        colorComplete = phenotype.includes('Roan') && phenotype.includes('Tobiano');
                        break;
                    default:
                        colorComplete = (phenotype === gameState.mission) || phenotype.includes(gameState.mission);
                        break;
                }
                
                if (colorComplete) {
                    let reward = MISSION_REWARDS[gameState.mission] || 100;
                    if (gameState.breedingsSinceMission > BREEDING_BONUS_THRESHOLD) {
                        reward += BREEDING_BONUS_AMOUNT;
                    }
                    totalReward += reward;
                    completedMissions.push(`Color: ${gameState.mission} (+$${reward})`);
                    document.getElementById('colorMission').classList.add('completed');
                }
            }
            
            // Check conformation mission
            if (!document.getElementById('confMission').classList.contains('completed')) {
                const confMission = gameState.missionConformation;
                if (confMission.minScore && horse.conformation >= confMission.minScore) {
                    confComplete = true;
                }
                
                if (confComplete) {
                    totalReward += confMission.reward;
                    completedMissions.push(`Conformation: ${confMission.target} (+$${confMission.reward})`);
                    document.getElementById('confMission').classList.add('completed');
                }
            }
            
            // Show success message if any mission completed
            if (completedMissions.length > 0) {
                gameState.money += totalReward;
                gameState.totalEarnings += totalReward;
                updateMoneyDisplay();
                
                const successMsg = document.getElementById('successMessage');
                successMsg.innerHTML = `
                    üéâ Mission${completedMissions.length > 1 ? 's' : ''} Complete!<br>
                    ${completedMissions.join('<br>')}<br>
                    <strong>Total: +$${totalReward}</strong>
                `;
                successMsg.style.display = 'block';
                
                // Auto-regenerate only the completed missions after a short delay
                setTimeout(() => {
                    if (colorComplete) {
                        gameState.breedingsSinceMission = 0;
                        generateColorMission();
                    }
                    if (confComplete) {
                        generateConfMission();
                    }
                    successMsg.style.display = 'none';
                    // Check achievements after mission completion
                    checkAchievements();
                }, 2000);
            }
        }

        // ============================================
        // GAME ACTIONS
        // ============================================
        function startGame() {
            const starterHorse = gameState.starterHorses[gameState.selectedStarter];
            showNamingModal(starterHorse, (name) => {
                starterHorse.name = name;
                gameState.stable.push(starterHorse);

                document.getElementById('startScreen').classList.remove('active');
                document.getElementById('gameScreen').classList.add('active');

                generateMission();
                updateMoneyDisplay();
                renderStable();
                renderStablePartners();
                renderAvailableHorses();
                renderAchievements();
                
                // Show intro popup for new players
                showIntro();
            });
        }

        function breedHorses() {
            const parent1 = gameState.selectedStableHorse;
            const parent2 = gameState.selectedPartner;

            // Check if both parents can breed
            const parent1Status = getBreedingStatus(parent1);
            const parent2Status = getBreedingStatus(parent2);
            
            if (!parent1Status.canBreed) {
                alert(`${parent1.name} cannot breed: ${parent1Status.reason}`);
                return;
            }
            
            if (!parent2Status.canBreed) {
                alert(`${parent2.name} cannot breed: ${parent2Status.reason}`);
                return;
            }

            const offspringGenotype = generateOffspring(parent1.genotype, parent2.genotype);
            const offspring = createHorseWithGenotype(offspringGenotype, null, parent1, parent2);

            showNamingModal(offspring, (name) => {
                offspring.name = name;
                gameState.stable.push(offspring);

                // Mark mares as bred this year (applies to stable mares only)
                if (parent1.gender === 'Mare') {
                    parent1.bredThisYear = true;
                }
                if (parent2.gender === 'Mare' && gameState.partnerSource === 'stable') {
                    parent2.bredThisYear = true;
                }

                // Increment breeding counter for mission bonus tracking
                gameState.breedingsSinceMission++;
                
                // Update breeding stats for achievements
                updateBreedingStats(offspring);

                // Reset refresh counter and refresh available horses after breeding
                gameState.refreshesRemaining = MAX_REFRESHES;
                renderAvailableHorses();

                clearBreedingSelection();
                renderStable();
                renderStablePartners();
                checkMission(offspring);
            });
        }

        let pendingHorse = null;
        let namingCallback = null;

        function showNamingModal(horse, callback) {
            pendingHorse = horse;
            namingCallback = callback;

            const modal = document.getElementById('namingModal');
            const icon = document.getElementById('newHorseIcon');
            const color = document.getElementById('newHorseColor');
            const genotype = document.getElementById('newHorseGenotype');
            const input = document.getElementById('horseNameInput');

            const displayName = horse.displayColor === 'Gray Alt' ? 'Gray' : horse.displayColor;
            const genderIcon = horse.gender === 'Stallion' ? '‚ôÇ' : '‚ôÄ';
            const genderClass = horse.gender.toLowerCase();
            const saleValue = getSaleValue(horse);
            const tempLabel = getTemperamentLabel(horse.temperament);
            const confLabel = getConformationLabel(horse.conformation);
            
            icon.innerHTML = `<img src="${HORSE_IMAGES[horse.displayColor]}" alt="${displayName} horse">`;
            color.innerHTML = `${displayName} <span class="horse-gender ${genderClass}">${genderIcon} ${horse.gender}</span>`;
            genotype.innerHTML = `
                <div class="horse-stats" style="margin-bottom: 8px;">
                    <span class="stat-badge temp-${horse.temperament <= 3 ? 'low' : horse.temperament <= 6 ? 'mid' : 'high'}">${tempLabel} (${horse.temperament})</span>
                    <span class="stat-badge conf-${horse.conformation <= 3 ? 'low' : horse.conformation <= 6 ? 'mid' : 'high'}">${confLabel} (${horse.conformation})</span>
                </div>
                ${horse.genotype}<br>
                <span class="horse-value">Value: $${saleValue}</span>
            `;
            input.value = '';

            modal.classList.add('active');
            setTimeout(() => input.focus(), 100);
        }

        function confirmNaming() {
            const input = document.getElementById('horseNameInput');
            const name = input.value.trim() || `Horse ${pendingHorse.id}`;

            document.getElementById('namingModal').classList.remove('active');

            if (namingCallback) {
                namingCallback(name);
            }

            pendingHorse = null;
            namingCallback = null;
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('selectStarterBtn').addEventListener('click', startGame);
        document.getElementById('breedBtn').addEventListener('click', breedHorses);
        document.getElementById('clearBreedingBtn').addEventListener('click', clearBreedingSelection);
        document.getElementById('refreshHorsesBtn').addEventListener('click', refreshHorses);
        document.getElementById('confirmNameBtn').addEventListener('click', confirmNaming);
        document.getElementById('horseNameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') confirmNaming();
        });
        document.getElementById('newMissionBtn').addEventListener('click', generateMission);
        document.getElementById('closePreviewBtn').addEventListener('click', closeHorsePreview);
        document.getElementById('advanceYearBtn').addEventListener('click', advanceYear);
        document.getElementById('closePedigreeBtn').addEventListener('click', closePedigree);
        document.getElementById('closePedigreeBtn2').addEventListener('click', closePedigree);
        document.getElementById('horsePreviewModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('horsePreviewModal')) {
                closeHorsePreview();
            }
        });
        document.getElementById('pedigreeModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('pedigreeModal')) {
                closePedigree();
            }
        });

        // Competition event listeners
        document.querySelectorAll('.competition-type-card').forEach(card => {
            card.addEventListener('click', () => {
                selectCompetitionType(card.dataset.compType);
            });
        });
        document.getElementById('enterCompetitionBtn').addEventListener('click', enterCompetition);
        document.getElementById('closeCompetitionBtn').addEventListener('click', closeCompetitionResults);
        document.getElementById('closeMedalHistoryBtn').addEventListener('click', closeMedalHistory);
        document.getElementById('competitionModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('competitionModal')) {
                closeCompetitionResults();
            }
        });
        document.getElementById('medalHistoryModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('medalHistoryModal')) {
                closeMedalHistory();
            }
        });

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                document.getElementById('outsideHorses').classList.toggle('active', tab === 'outside');
                document.getElementById('stableBreeding').classList.toggle('active', tab === 'stable');
            });
        });

        // Hint button listeners
        document.getElementById('colorHintBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            toggleHint('colorHintPopup');
        });
        document.getElementById('confHintBtn').addEventListener('click', (e) => {
            e.stopPropagation();
            toggleHint('confHintPopup');
        });
        
        // Close hints when clicking elsewhere
        document.addEventListener('click', () => {
            document.querySelectorAll('.hint-popup').forEach(p => p.classList.remove('active'));
        });
        
        // Guide and intro modal listeners
        document.getElementById('helpBtn').addEventListener('click', showGuide);
        document.getElementById('closeGuideBtn').addEventListener('click', closeGuide);
        document.getElementById('closeGuideBtn2').addEventListener('click', closeGuide);
        document.getElementById('guideModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('guideModal')) {
                closeGuide();
            }
        });
        
        document.getElementById('closeIntroBtn').addEventListener('click', closeIntro);
        document.getElementById('introModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('introModal')) {
                closeIntro();
            }
        });

        // AI Chat event listeners
        document.getElementById('saveApiKeyBtn').addEventListener('click', saveApiKey);
        document.getElementById('apiKeyInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') saveApiKey();
        });
        document.getElementById('sendChatBtn').addEventListener('click', sendChatMessage);
        document.getElementById('chatInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });
        document.querySelectorAll('.suggestion-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                handleSuggestionClick(chip.dataset.question);
            });
        });

        // ============================================
        // INITIALIZE
        // ============================================
        renderStarterHorses();
        initializeChat();
    </script>
</body>
</html>
